列类型变更规则 
============================

在 OceanBase 数据库 Oracle 模式下进行列类型变更时，需要首先考虑表级的列类型变更规则，特别是一些数据类型的禁用场景；其次是考虑列类型变更中源数据类型和目标数据类型的变更规则。

表级列类型变更规则 
------------------------------

### 禁用规则 

* 外键约束

  对于 Online DDL 和 Offline DDL，只支持 `VARCHAR`、`VARCHAR2`、`NVARCHAR2` 改大或改小精度。
  

* Trigger 约束

  仅针对 Offline DDL，当列上有非 `DISABLE` 的 Trigger 约束时，禁止修改列类型；如果全部是 `DISABLE` 的 Trigger，则不影响 DDL，并且新表里需要包含这个 `DISABLE` 的 Trigger。
  

* 分区键

  对于 Online DDL 和 Offline DDL，当列作为分区键一部分时，禁掉修改类型和修改长度的功能。
  

* 对于 Online DDL 和 Offline DDL，如果修改的列被生成列引用，则禁掉列类型变更功能。

  




### 变更规则 

* 在相同数据类型长度变长的情况下，虽然用户预期数据发生变化，例如将某一列的数据类型 `CHAR` 更改为 `CHAR(11)`，由于 OceanBase 数据库存储 `CHAR` 的方式可以是 Online 操作，也不需要重写数据，如果该列上只有索引表，那么可以通过 Online 的方式修改索引列的长度。但如果该列修改了主键或者分区键，则还是应该执行 Offline 操作，对于 `CHECK` 约束依赖的情况，因用户预期数据发生变长，可能导致不满足 `CHECK` 约束，此时也应该是执行 Offline 操作，即" **同类型变长有 CHECK 约束、主键、分区键要 Offline** "。

  对于 `VARCHAR` 类型的长度变长的情况，例如 `LENGTH(c1)` 这样的操作不会发生变化，所以可以通过 Online 的方式变更，但是需要同时修改索引表等相关依赖对象的 Schema。需要注意的是，这种情况即使变更了主键或者分区键，也可以是 Online 方式的，即" **用户预期数据不发生变化，但依赖对象中的 Schema 也要跟着改掉** "。
  

* 在 OceanBase 数据库中，可能有相同大数据类型（即数值数据类型、字符数据类型、时间数据类型、`ROWID` 数据类型）的变更，如果该类上没有被索引表、外键、`CHECK` 约束、主键等引用的情况，是可以通过 Online 的方式表更，但是如果被这些依赖对象引用，需要通过 Offline 的方式，即" **大类型变更有依赖对象要 Offline"。**

  

* 对于数值数据类型，如果出现 `SIGNED` 和 `UNSIGNED` 变化，在允许类型变更的情况下，需要执行 Offline 操作。

  




列级变更规则 
---------------------------

在 OceanBase 数据库中，所有列数类型分为三个大类，分别是数值数据类型、字符数据类型、时间数据类型、间隔数据类型和 `ROWID` 类型。

OceanBase 数据库当前版本中，`ROWID` 和 `UROWID` 类型实际在内部都实现成了 `UROWID` 类型，所以 `ROWID`和 `UROWID` 的转换规则，等同于 `UROWID` 与 `UROWID` 之间的转换规则。

在 OceanBase 数据库 Oracle 模式中大类型之间是不允许互相转换，因此，我们只关注大类型内部的转换规则。

### 数值数据类型大类内的变更规则 

数值数据类型分为：

* `NUMBER`

  

* `FLOAT`

  **注意**

  

  `FLOAT(p)` 不是浮点数，是 `NUMBER` 数据类型的子类型，它的二进制精度范围为 \[1,126\]。
  

* `BINARY_FLOAT`

  

* `BINARY_DOUBLE`

  




如下表格为数值数据类型大类内的变更规则。


|      数据类型       |                                                                                                                                 NUMBER                                                                                                                                 |                                                                                                                                     FLOAT                                                                                                                                     |             BINARY_FLOAT              |             BINARY_DOUBLE             |
|-----------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|---------------------------------------|
| `NUMBER`        | 如果源数据类型精度小于目的数据类型精度，允许转换，执行 Online DDL，不需要重写数据。用户预期数据不发生变化，但要同时更改依赖对象中的 Schema。 如果源数据类型精度大于等于目的数据类型精度： * 严格模式下，如果数据超出存储范围，则会报错。不报错时可以进行校验。   * 非严格模式下，如果数据超出存储范围，则会被截断，无法执行校验。    | 如果源数据类型精度小于目的数据类型精度，则允许转换，执行 Online DDL，不需要重写数据。用户预期数据不发生变化，但要同时更改依赖对象中的 Schema。 如果源数据类型精度大于等于目的数据类型精度，则会报错，无法执行校验。                                                                                                                                                           | 会报错。                                  | 会报错。                                  |
| `FLOAT`         | 如果源数据类型精度小于等于目的数据类型精度，允许转换，执行 Online DDL，不需要重写数据。用户预期数据不发生变化，但要同时更改依赖对象中的 Schema。 如果源数据类型精度大于目的数据类型精度，则会报错，无法执行校验。                                                                                                                                                     | 如果源数据类型精度小于等于目的数据类型精度，允许转换，执行 Online DDL，不需要重写数据。用户预期数据不发生变化，但要同时更改依赖对象中的 Schema。 如果源数据类型精度大于目的数据类型精度，转换规则如下： * 严格模式下，如果数据超出存储范围，则会报错，不报错时可以进行校验。   * 非严格模式下，如果数据超出存储范围，则会被截断，无法执行校验。    | 会报错。                                  | 会报错。                                  |
| `BINARY_FLOAT`  | 会报错。                                                                                                                                                                                                                                                                   | 会报错。                                                                                                                                                                                                                                                                          | 允许转换，执行 Online DDL，不需要重写数据，用户不期望数据重写。 | 会报错。                                  |
| `BINARY_DOUBLE` | 会报错。                                                                                                                                                                                                                                                                   | 会报错。                                                                                                                                                                                                                                                                          | 会报错。                                  | 允许转换，执行 Online DDL，不需要重写数据，用户不期望数据重写。 |



### 字符数据类型大类内类型转换 

字符数据类型分为：

* `CHAR`

  

* `VARCHAR`、`VARCHAR2`：`VARCHAR` 和 `VARCHAR2` 是同一个类型。

  

* `NCHAR`、`NVARCHAR2`：所有字符使用两个字节表示。

  

* `BLOB`：字符集是 `BINARY`。

  

* `CLOB`：字符集是 `UTF8MB4`。

  

* `RAW`：无论是哪种字符集，都以二进制形式存储。

  




如下表格为字符数据类型大类内的变更规则。


|         数据类型         |                                                                                               To CHAR                                                                                               |                                                                                                    To VARCHAR、VARCHAR2                                                                                                    |                           To NCHAR                            |                            To NVARCHAR2                            |     To BLOB     |     To CLOB     |                               To RAW                               |
|----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|--------------------------------------------------------------------|-----------------|-----------------|--------------------------------------------------------------------|
| `CHAR`               | 精度变长时，执行 Online DDL，不需要重写数据，并遵循"同类型变长有 `CHECK` 约束、主键、分区键要Offline"。无转换规则。                                                                                                            | 精度变长时，执行 Offline DDL，需要重写数据，无转换规则，需要进行校验。                                                                                                                                                                                 | 执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会报错。             | 禁止转换。                                                              | 涉及字符集的变更，禁止转换。  | 禁止转换。           | 禁止转换。                                                              |
| `CHAR`               | 精度变短时，转换规则如下： * 严格模式下，如果源数据转换后的长度超过目标字符串的长度时，会报错。不报错的情况下，可以进行校验。   * 非严格模式下，源数据可能会被截断，无法进行校验。    | 精度变短时，转换规则如下： * 严格模式下，如果源数据转换后的长度超过目标字符串的长度时，会报错。不报错的情况下，可以进行校验。   * 非严格模式下，源数据可能会被截断，无法进行校验。                          | 执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会报错。             | 禁止转换。                                                              | 涉及字符集的变更，禁止转换。  | 禁止转换。           | 禁止转换。                                                              |
| `VARCHAR`、`VARCHAR2` | 精度变长时，执行 Online DDL，不需要重写数据，并遵循"大类型变更有依赖对象要 Offline"。无转换规则。                                                                                                                         | 精度变长时，执行 Online DDL，不需要重写数据，用户预期数据不发生变化，但需要同时修改依赖对象中的Schema。无转换规则。                                                                                                                                                        | 执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会报错。             | 禁止转换。                                                              | 涉及字符集的变更，禁止转换。  | 禁止转换。           | 禁止转换。                                                              |
| `VARCHAR`、`VARCHAR2` | 精度变短时，执行 Offline DDL，需要重写数据，如果源数据转换后的长度超过目标字符串的长度时，会报错。                                                                                                                                             | 精度变短时，执行 Offline DDL，需要重写数据，转换规则如下： * 严格模式下，如果源数据转换后的长度超过目标字符串的长度时，会报错。不报错的情况下，可以进行校验。   * 非严格模式下，源数据可能会被截断，无法进行校验。    | 执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会报错。             | 禁止转换。                                                              |                 |                 |                                                                    |
| `NCHAR`              | 禁止转换。                                                                                                                                                                                               | 禁止转换。                                                                                                                                                                                                                     | 精度变长时，执行 Offline DDL，需要重写数据，无转换规则。 精度变短时，会报错。 | 精度变长时，执行 Offline DDL，需要重写数据，无转换规则。 精度变短时，会报错。      | 禁止转换。           | 禁止转换。           | 禁止转换。                                                              |
| `NVARCHAR2`          | 禁止转换。                                                                                                                                                                                               | 禁止转换。                                                                                                                                                                                                                     | 执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会报错。             | 精度变长时，执行 Online DDL，不需要重写数据，用户预期数据不发生变化，但需要同时修改依赖对象中的Schema。无转换规则。 | 禁止转换。           | 禁止转换。           | 禁止转换。                                                              |
| `NVARCHAR2`          | 禁止转换。                                                                                                                                                                                               | 禁止转换。                                                                                                                                                                                                                     | 执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会报错。             | 精度变短时，执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会报错。            | 禁止转换。           | 禁止转换。           | 禁止转换。                                                              |
| `BLOB`               | 涉及字符集的变更，禁止转换。                                                                                                                                                                                      | 涉及字符集的变更，禁止转换。                                                                                                                                                                                                            | 禁止转换。                                                         | 禁止转换。                                                              | 允许转换，但实际没有任何操作。 | 涉及字符集的变更，禁止转换。  | 禁止转换。                                                              |
| `CLOB`               | 禁止转换。                                                                                                                                                                                               | 禁止转换。                                                                                                                                                                                                                     | 禁止转换。                                                         | 禁止转换。                                                              | 涉及字符集的变更，禁止转换。  | 允许转换，但实际没有任何操作。 | 禁止转换。                                                              |
| `RAW`                | 禁止转换。                                                                                                                                                                                               | 禁止转换。                                                                                                                                                                                                                     | 禁止转换。                                                         | 禁止转换。                                                              | 禁止转换。           | 禁止转换。           | 精度变长时，执行 Online DDL，不需要重写数据，用户预期数据不发生变化，但需要同时修改依赖对象中的Schema。无转换规则。 |
| `RAW`                | 禁止转换。                                                                                                                                                                                               | 禁止转换。                                                                                                                                                                                                                     | 禁止转换。                                                         | 禁止转换。                                                              | 禁止转换。           | 禁止转换。           | 精度变短时，执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会报错。            |



### 日期时间数据类型大类内的变更规则 

日期时间数据类型分为：

* `DATE`

  

* `TIMESTAMP`

  

* `TIMESTAMP WITH TIME ZONE`

  

* `TIMESTAMP WITH LOCAL TIME ZONE`

  




如下表格为日期时间数据类型大类内的变更规则。


|               数据类型               |                                                        To DATE                                                         |                                                    To TIMESTAMP                                                    |                                                 To TIMESTAMP WITH TIME ZONE                                                  |                                              To TIMESTAMP WITH LOCAL TIME ZONE                                               |
|----------------------------------|------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|
| `DATE`                           | 允许转换，但实际没有任何操作。                                                                                                        | 执行 Offline DDL，需要重写数据。异常情况会报错"Alter non string type not supported"。                                                | 异常情况会报错"Alter non string type not supported"。                                                                                | 执行 Offline DDL，需要重写数据。异常情况会报错"Alter non string type not supported"。                                                          |
| `TIMESTAMP`                      | 执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会截断小数后面的数据。                                                               | 源数据类型精度小于等于目的数据类型精度时，执行 Online DDL，不需要重写数据，并遵循"大类型变更有依赖对象要 Offline"。无转换规则。 源数据类型精度大于目的数据类型精度时，会报错。 | 会报错。                                                                                                                         | 会报错。                                                                                                                         |
| `TIMESTAMP WITH TIME ZONE`       | 会报错。                                                                                                                   | 会报错。                                                                                                               | 源数据类型精度小于等于目的数据类型精度时，执行 Online DDL，不需要重写数据，用户预期数据不发生变化，但依赖对象中的 Schema 也要跟着改掉。无转换规则。 源数据类型精度大于目的数据类型精度时，会被截断。 | 会报错。                                                                                                                         |
| `TIMESTAMP WITH LOCAL TIME ZONE` | 执行 Offline DDL，需要重写数据。如果源数据转换后的长度超过目标字符串的长度，则会截断小数后面的数据。 异常情况会报错"Alter non string type not supported"。 | 会报错。                                                                                                               | 会报错。                                                                                                                         | 源数据类型精度小于等于目的数据类型精度时，执行 Online DDL，不需要重写数据，用户预期数据不发生变化，但依赖对象中的 Schema 也要跟着改掉。无转换规则。 源数据类型精度大于目的数据类型精度时，会被截断。 |



### 间隔数据类型大类内转换 

间隔数据类型分为：

* `INTERVAL YEAR TO MONTH`

  

* `INTERVAL DAY TO SECOND`

  




如下表格为间隔数据类型大类内的变更规则。


|          数据类型          |                                                  To INTERVAL YEAR TO MONTH                                                   |                                                  To INTERVAL DAY TO SECOND                                                  |
|------------------------|------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| INTERVAL YEAR TO MONTH | 源数据类型精度小于等于目的数据类型精度时，执行 Online DDL，不需要重写数据，用户预期数据不发生变化，但依赖对象中的 Schema 也要跟着改掉。无转换规则。 源数据类型精度大于目的数据类型精度时，会被截断。 | 会报错。                                                                                                                        |
| INTERVAL DAY TO SECOND | 会报错。                                                                                                                         | 源数据类型精度小于等于目的数据类型精度时，执行 Online DDL，不需要重写数据，用户预期数据不发生变化，但依赖对象中的Schema 也要跟着改掉。无转换规则。 源数据类型精度大于目的数据类型精度时，会被截断。 |



### ROWID 数据类型大类内转换 

`ROWID` 数据类型分为：

* `ROWID`

  

* `UROWID`

  




如下表格为 `ROWID` 数据类型大类内的变更规则。


|  数据类型  |                      To ROWID                       |                                                                 To UROWID                                                                  |
|--------|-----------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| ROWID  | 与 `UROWID` 转 `UROWID` 的行为相同。源数据类型长度小于目的数据类型长度时，会报错。 | 与 `UROWID` 转 `UROWID` 的行为相同。                                                                                                               |
| UROWID | 与 `UROWID` 转 `UROWID` 的行为相同。                        | 源数据类型长度小于等于目的数据类型长度时，执行 Online DDL，不需要重写数据，用户预期数据不发生变化，但依赖对象中的Schema 也要跟着改掉。 源数据类型长度大于目的数据类型长度时，执行 Offline DDL，需要重写数据，会报错。 |




# 约束相关问题

本文主要介绍约束相关问题的报错信息及处理方法。

## 唯一键冲突

当表上有唯一性约束时，再插入相同的记录，数据库就会报错。

### 报错信息

例如，向 `t_insert` 表中插入数据时，显示主键值 `3` 重复。

```sql
obclient> SELECT * FROM t_insert;
+----+------+-------+---------------------+
| id | name | value | gmt_create          |
+----+------+-------+---------------------+
|  1 | CN   | 10001 | 2022-10-12 15:17:17 |
|  2 | US   | 10002 | 2022-10-12 16:29:16 |
|  3 | EN   | 10003 | 2022-10-12 16:29:26 |
+----+------+-------+---------------------+
3 rows in set

obclient> INSERT INTO t_insert(id, name, value) VALUES (3,'UK', 10003),(4, 'JP', 10004);
ERROR 1062 (23000): Duplicate entry '3' for key 'PRIMARY'
```

该报错信息对应的错误码信息如下：

* 错误码：ERROR 1062

* OceanBase 错误码：5024

* 兼容 MySQL 错误码：1062

有关错误码的详细说明及介绍，请参见 [错误码概述](../../../7.reference/5.system-reference/6.error-code-for-mysql/1.use-error-information-1.md)。

### 处理方法

**方法一**：通过 `INSERT IGNORE INTO` 语句避免约束冲突，`IGNORE` 关键字可以忽略由于约束冲突导致的 `INSERT` 失败的影响。

1. 在 `t_insert` 表插入数据时添加 `IGNORE` 关键字。

   ```sql
   obclient> SELECT * FROM t_insert;
   +----+------+-------+---------------------+
   | id | name | value | gmt_create          |
   +----+------+-------+---------------------+
   |  1 | CN   | 10001 | 2022-10-12 15:17:17 |
   |  2 | US   | 10002 | 2022-10-12 16:29:16 |
   |  3 | EN   | 10003 | 2022-10-12 16:29:26 |
   +----+------+-------+---------------------+
   3 rows in set

   obclient> INSERT IGNORE INTO t_insert(id, name, value) VALUES (3,'UK', 10003),(4, 'JP', 10004);
   Query OK, 1 row affected
   ```

2. 再次查看 `t_insert` 表的数据。可以看到，与主键值相同的记录被丢弃，与主键值不同的记录插入成功。

   ```sql
   obclient> SELECT * FROM t_insert;
   +----+------+-------+---------------------+
   | id | name | value | gmt_create          |
   +----+------+-------+---------------------+
   |  1 | CN   | 10001 | 2022-10-12 15:17:17 |
   |  2 | US   | 10002 | 2022-10-12 16:29:16 |
   |  3 | EN   | 10003 | 2022-10-12 16:29:26 |
   |  4 | JP   | 10004 | 2022-10-12 17:02:52 |
   +----+------+-------+---------------------+
   4 rows in set
   ```

**方法二**：通过 `INSERT INTO ON DUPLICATE KEY UPDATE` 避免约束冲突，可以指定对重复主键或唯一键的后续处理，以下示例对冲突行内容进行了更新。

  >**说明**
  >
  >* 指定 `ON DUPLICATE KEY UPDATE column_name = expr`：当要插入的主键或唯一键有重复值时，可以使用 `column_name = expr` 赋值语句来更新表中冲突行的数据。`column_name = expr` 赋值语句可以为冲突行赋某一列或几列的值。赋多列值时，列与列之间用逗号分隔。
  >
  >* 不指定 `ON DUPLICATE KEY UPDATE column_name = expr`：当要插入的主键或唯一键有重复值时，系统会报错。

1. 在 `t_insert` 表插入数据时通过 `INSERT INTO ON DUPLICATE KEY UPDATE` 避免约束冲突。

   ```sql
      obclient> SELECT * FROM t_insert;
   +----+------+-------+---------------------+
   | id | name | value | gmt_create          |
   +----+------+-------+---------------------+
   |  1 | CN   | 10001 | 2022-10-12 15:17:17 |
   |  2 | US   | 10002 | 2022-10-12 16:29:16 |
   |  3 | EN   | 10003 | 2022-10-12 16:29:26 |
   +----+------+-------+---------------------+
   3 rows in set

   obclient> INSERT INTO t_insert(id, name, value) VALUES (3,'UK', 10003),(4, 'JP', 10004) ON DUPLICATE KEY UPDATE name=VALUES(name);
   Query OK, 1 row affected
   ```

2. 再次查看 `t_insert` 表的数据。可以看到，与主键值相同的记录被更新，与主键值不同的记录插入成功。

   ```sql
   obclient> select * from t_insert;
   +----+------+-------+---------------------+
   | id | name | value | gmt_create          |
   +----+------+-------+---------------------+
   |  1 | CN   | 10001 | 2022-10-12 15:17:17 |
   |  2 | US   | 10002 | 2022-10-12 16:29:16 |
   |  3 | UK   | 10003 | 2022-10-12 16:29:26 |
   |  4 | JP   | 10004 | 2022-10-12 18:04:32 |
   +----+------+-------+---------------------+
   4 rows in set
   ```

## 外键冲突

### 报错信息

添加外键约束时，如果外键的字段与关联字段的类型不匹配时，系统会报错。

例如，为 `cust` 表创建外键约束时，显示关联字段错误。

```sql
obclient> ALTER TABLE cust ADD CONSTRAINT ware FOREIGN KEY (c_w_id) REFERENCES ware(w_name);
ERROR 1215 (HY000): Cannot add foreign key constraint
```

该报错信对应的错误码信息如下：

* 错误码：ERROR 1215

* OceanBase 错误码：5317

* 兼容 MySQL 错误码：1215

有关错误码的详细说明及介绍，请参见 [错误码概述](../../../7.reference/5.system-reference/6.error-code-for-mysql/1.use-error-information-1.md)。

### 处理方法

1. 查看 `ware` 和 `cust` 表的表结构，并找到关联表的主键。

   ```sql
   obclient> DESC WARE;
   +--------+--------------+------+-----+---------+-------+
   | Field  | Type         | Null | Key | Default | Extra |
   +--------+--------------+------+-----+---------+-------+
   | w_id   | int(11)      | NO   | PRI | NULL    |       |
   | w_name | varchar(256) | YES  | UNI | NULL    |       |
   | w_city | varchar(256) | YES  | UNI | NULL    |       |
   +--------+--------------+------+-----+---------+-------+
   3 rows in set

   obclient> DESC cust;
   +--------+---------+------+-----+---------+-------+
   | Field  | Type    | Null | Key | Default | Extra |
   +--------+---------+------+-----+---------+-------+
   | c_id   | int(11) | NO   | PRI | NULL    |       |
   | c_w_id | int(11) | YES  |     | NULL    |       |
   +--------+---------+------+-----+---------+-------+
   2 rows in set
   ```

2. 重新创建表 `cust` 的外键约束。

   ```sql
   obclient> ALTER TABLE cust ADD CONSTRAINT ware FOREIGN KEY (c_w_id) REFERENCES ware(w_id);
   Query OK, 0 rows affected
   ```

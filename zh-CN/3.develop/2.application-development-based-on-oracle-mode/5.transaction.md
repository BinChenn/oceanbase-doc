# 事务

本文介绍了事务的基本信息、控制语句以及事务的开启、提交和回滚方法。

## 事务简介

数据库事务包含了数据库上的一系列操作，事务使得数据库从一个一致的状态转化到另一个一致的状态。通常事务中的 SQL 会包含 DML 语句，也会包含查询语句。如果一个事务中的 SQL 只有查询语句，这个事务通常称为只读事务。

事务在没有提交之前，可以使用 `ROLLBACK` 命令回滚事务。更多事务相关的说明，请参考 [事务简介](../../7.reference/1.concepts-of-oceanbase-database-system/8.transaction-management-1/1.transaction-2/1.transaction-introduction.md)。

基本的事务控制语句如下：

* `BEGIN`：显式开启一个事务。此语句在使用过程中可选。

  * 租户会话的系统变量 `autocommit` 的值为 `0` 时，表示关闭事务自动提交功能，就不需要显式发出 `BEGIN` 命令来标识多个 SQL 组成一个事务。

  * 租户会话的系统变量 `autocommit` 的值为 `1` 时，表示开启事务自动提交功能，该模式下，每条 SQL 都是一个独立的事务。如果要多个 SQL 组成一个事务，可以通过 `BEGIN` 命令显式开启一个事务，同时会禁用自动提交功能，直到执行 `COMMIT` 或 `ROLLBACK` 语句，才会恢复到自动提交模式。

* `SAVEPOINT`：可以在事务过程中标记一个"保存点"，事务可以事后选择回滚到这个保存点上。保存点是可选的，一个事务过程中也可以设置多个保存点。

* `COMMIT`：提交并结束当前事务，让事务所有修改持久化并生效，清除所有保存点和释放事务持有的锁。

* `ROLLBACK`：回滚整个事务已做的修改或者只回滚某个保存点之后事务已做的修改，清除回滚部分包含的所有保存点和释放事务持有的锁。

在 obclient 命令环境下，可以在 SQL 提示符后发起事务控制命令，也可以修改会话级别的 `autocommit` 参数来控制事务是否自动提交。

* 通过 `SET autocommit` 设置变量时，当前会话立即生效，断开链接之后被设置的变量会失效。

* 通过 `SET GLOBAL autocommit` 设置租户级别的变量时，需要断开链接并重新连接才能生效。

> **说明**
>
> 如果会话中的变量 `autocommit` 的值为 `0`，并且没有显式提交事务，程序异常中断时，OceanBase 数据库会自动回滚最后一个未提交的事务。

## 开启事务

OceanBase 数据库的事务控制语句与 Oracle 数据库兼容，OceanBase 数据库的 Oracle 模式可以通过以下方式开启一个事务：

* 执行 `BEGIN` 命令

  ```sql
  obclient [SYS]> BEGIN;      //开启事务
  obclient [SYS]> INSERT INTO table1 VALUES(1,1);  
  obclient [SYS]> COMMIT;
  ```

* 执行 `START TRANSACTION` 命令

  ```sql
  obclient [SYS]> START TRANSACTION; //开启事务
  obclient [SYS]> INSERT INTO table1 VALUES(1,1);  
  obclient [SYS]> COMMIT;
  ```

  >**注意**
  >
  > `BEGIN` 作为 `START TRANSACTION` 的别名，用于启动事务。

* 配置 `autocommit = 0`（关闭自动提交）后，执行 `INSERT`、`UPDATE`、`DELETE`、`SELECT FOR UPDATE` 语句时，系统会会开启一个新事务。

  ```sql
  obclient [SYS]> SET AUTOCOMMIT=0;
  obclient [SYS]> INSERT INTO table1 VALUES(1,1);  //开启事务
  obclient [SYS]> COMMIT;
  
  obclient [SYS]> SET AUTOCOMMIT=0;
  obclient [SYS]> UPDATE table1 SET id = 2 WHERE id = 1;  //开启事务
  obclient [SYS]> COMMIT;
  
  obclient [SYS]> SET AUTOCOMMIT=0;
  obclient [SYS]> DELETE FROM table1 WHERE id = 2;  //开启事务
  obclient [SYS]> COMMIT;
  
  obclient [SYS]> SET AUTOCOMMIT=0;
  obclient [SYS]> SELECT id FROM table1 WHERE id = 1 FOR UPDATE;  //开启事务
  obclient [SYS]> COMMIT;
  ```

当事务开启时，OceanBase 数据库为事务分配一个事务 ID，用于唯一的标识一个事务。

在实际使用中，多个并发的连接下，对同一个数据表进行操作时，可能会出现两个事务对同一行数据进行操作。对于查询的读操作，可以通过 `SELECT FOR UPDATE` 语句锁定查询结果，避免其他 DML 语句对该笔记录进行同时修改。`SELECT FOR UPDATE` 语句的详细使用方法，请参见 [锁定查询结果 SELECT FOR UPDATE](4.read-data-for-oracle-mode/8.use-operators-and-functions-in-query-for-oracle-mode/10.lock-query-result-select-for-update.md)。

示例：先通过 `SET autocommit=0` 关闭自动提交功能，再通过 `UPDATE` 语句开启一个事务。

```sql
obclient [SYS]> CREATE TABLE ordr(
id NUMBER NOT NULL PRIMARY KEY,
name VARCHAR2(10) NOT NULL,
value NUMBER,
gmt_create DATE NOT NULL DEFAULT sysdate );
Query OK, 0 rows affected

obclient [SYS]>  INSERT INTO ordr(id, name, value)
VALUES (1,'CN',10001),(2,'US', 10002),(3,'EN', 10003);
Query OK, 3 rows affected
 Records: 3  Duplicates: 0  Warnings: 0

obclient [SYS]> SELECT * FROM ordr;
+----+------+-------+---------------------+
| id | name | value | gmt_create          |
+----+------+-------+---------------------+
|  1 | CN   | 10001 | 2022-10-19 14:51:12 |
|  2 | US   | 10002 | 2022-10-19 14:51:12 |
|  3 | EN   | 10003 | 2022-10-19 14:51:12 |
+----+------+-------+---------------------+
2 rows in set

obclient [SYS]> SET autocommit=0;
Query OK, 0 rows affected 

obclient [SYS]> UPDATE t SET c="b" WHERE i=1;
Query OK, 1 row affected 
Rows matched: 1  Changed: 1  Warnings: 0
```

可以通过视图 `V$OB_TRANSACTION_PARTICIPANTS` 查询事务的状态。

```sql
obclient [SYS]> SELECT * FROM V$OB_TRANSACTION_PARTICIPANTS;
*************************** 1. row ***************************
       TENANT_ID: 1004
          SVR_IP: XX.XX.XX.223
        SVR_PORT: 2882
      SESSION_ID: 3221487658
  SCHEDULER_ADDR: "XX.XX.XX.223:2882"
         TX_TYPE: UNDECIDED
           TX_ID: 77130
           LS_ID: 1001
    PARTICIPANTS: NULL
 CTX_CREATE_TIME: 02-NOV-22 02.58.12.850332 PM
 TX_EXPIRED_TIME: 03-NOV-22 02.58.12.850332 PM
           STATE: ACTIVE
          ACTION: START
PENDING_LOG_SIZE: 48
FLUSHED_LOG_SIZE: 0
            ROLE: LEADER
1 row in set
```

视图 `$OB_TRANSACTION_PARTICIPANTS` 中的字段及详细说明请参见 [$OB_TRANSACTION_PARTICIPANTS](../../7.reference/2.manage-guide/8.system-reference/5.system-view-for-oracle/3.performance-view-6/49.v-ob_transaction_participants-1.md)。

## 事务保存点

`SAVEPOINT` 语句可以在事务过程中标记一个"保存点"，事务可以选择回滚到这个保存点。保存点是可选的，一个事务过程中也可以有多个保存点。

### 标记保存点

标记保存点的语法格式如下：

```sql
SAVEPOINT pointname;
```

其中，`pointname` 表示事务保存点的名称。

### 回滚事务到保存点

保存点标记后，可以通过 `ROLLBACK TO SAVEPOINT` 语句回滚到指定事务保存点，语法格式如下：

```sql
ROLLBACK TO SAVEPOINT pointname;
```

回滚事务的详细示例及说明，请参见本文 [回滚事务](#回滚到某个保存点)。

## 提交事务

提交一个事务会让事务的修改持久化生效，清除保存点并释放事务所持有的所有锁。

OceanBase 数据库 Oracle 模式的提交事务可以显式使用也可以隐式使用。显式地提交事务，需要使用 `COMMIT` 语句或者使用提交按钮（在图形化客户端工具中）结束事务；隐式提交事务时不需要主动提交，当系统变量 `autommit` 的值为 `1` 时，每条语句执行结束后，OceanBase 数据库即会自动地将这条语句所在的事务提交，一条语句就是一个事务。

> **说明**
>
> OceanBase 数据库会在 DDL 语句前和后隐式地发起一个 `COMMIT` 语句，也会提交事务。

* 如果使用 `BEGIN` 开启一个事务，执行 DML 语句后，需要使用 `COMMIT` 提交事务。

  * 在您提交事务之前，您的修改只对当前会话可见，对其他数据库会话是不可见的；您的修改没有持久化，所以不是最终的结果，可以用 `ROLLBACK` 语句回滚这些修改。

  * 在您提交事务之后，您的修改对所有数据库会话可见。您的修改结果持久化成功，不可以用 `ROLLBACK` 语句回滚这些修改。

    > **说明**
    >
    > 如果事务隔离级别设置了可重复读，则已经开启事务的会话无法查询到新提交的数据。事务隔离级别的更多介绍请参见 [事务隔离级别](../../7.reference/1.concepts-of-oceanbase-database-system/8.transaction-management-1/2.transaction-concurrency-and-consistency/4.transaction-isolation-level/2.oracle-7.md)。

* 如果隐式地开启事务（开启了自动提交事务，即 `autocommit` 的值为 `1`），则一条 SQL 就是一个事务，不再需要提交事务。SQL 执行后您的修改即持久化成功，不可以用 `ROLLBACK` 语句回滚这些修改。

### 显示提交事务

以下示例通过 `BEGIN` 开始一个事务，然后使用 `INSERT` 在表 `ordr` 中插入数据，最后通过 `COMMIT` 语句提交。

```sql
obclient [SYS]> SELECT * FROM ordr;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 03-NOV-22  |
|  2 | US   | 10002 | 03-NOV-22  |
|  3 | EN   | 10003 | 03-NOV-22  |
+----+------+-------+------------+
3 rows in set

obclient [SYS]> BEGIN;
Query OK, 0 rows affected 

obclient [SYS]> INSERT INTO ordr(id,name) VALUES(4,'JP');
Query OK, 1 row affected 

obclient [SYS]> COMMIT;
Query OK, 0 rows affected
```

执行成功后，退出会话再重新连接，发现表数据已正确插入并保存成功。

```sql
obclient [SYS]> exit;

$obclient -h192.168.0.0 -utpcc@obbmsql#obdemo -P2883 -p**1***
Welcome to the OceanBase.  Commands end with ; or \g.
Your OceanBase connection id is 3221487661
Server version: OceanBase 4.0.0.0 (r100000252022102910-df01cef074936b9c9f177697500fad1dc304056f) (Built Oct 29 2022 10:27:50)

Copyright (c) 2000, 2018, OB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

obclient [SYS]> SELECT * FROM ordr;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 03-NOV-22  |
|  2 | US   | 10002 | 03-NOV-22  |
|  3 | EN   | 10003 | 03-NOV-22  |
|  4 | JP   | NULL  | 03-NOV-22  |
+----+------+-------+------------+
4 rows in set
```

### 隐式提交事务

以下示例，通过配置变量 `autocommit=1`，开启自动提交。

```sql
obclient [SYS]> SELECT * FROM ordr;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 03-NOV-22  |
|  2 | US   | 10002 | 03-NOV-22  |
|  3 | EN   | 10003 | 03-NOV-22  |
+----+------+-------+------------+
4 rows in set

obclient> SET autocommit=1;
Query OK, 1 row affected 

INSERT INTO ordr(id,name) VALUES(4,'JP');
Query OK, 1 row affected 
```

执行成功后，退出会话再重新连接，发现表数据已正确插入并保存成功。

```sql
obclient [SYS]> exit;

$obclient -h192.168.0.0 -utpcc@obbmsql#obdemo -P2883 -p**1***
Welcome to the OceanBase.  Commands end with ; or \g.
Your OceanBase connection id is 3221487664
Server version: OceanBase 4.0.0.0 (r100000252022102910-df01cef074936b9c9f177697500fad1dc304056f) (Built Oct 29 2022 10:27:50)

Copyright (c) 2000, 2018, OB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

obclient [SYS]> SELECT * FROM ordr;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 03-NOV-22  |
|  2 | US   | 10002 | 03-NOV-22  |
|  3 | EN   | 10003 | 03-NOV-22  |
|  4 | JP   | NULL  | 03-NOV-22  |
+----+------+-------+------------+
4 rows in set
```

## 回滚事务

回滚一个事务是指将事务的修改全部撤销，可以回滚当前整个未提交事务，也可以回滚到事务中任意一个保存点。

### 回滚整个事务

回滚整个事务时：

* 所有的修改会被丢弃。

* 清除所有保存点。

* 释放事务持有的所有锁。

语句语法格式如下：

```sql
ROLLBACK;
```

以下示例通过 `ROLLBACK` 回滚当前事务的全部修改。

```sql
obclient> SELECT * FROM ordr;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 03-NOV-22  |
|  2 | US   | 10002 | 03-NOV-22  |
|  3 | EN   | 10003 | 03-NOV-22  |
+----+------+-------+------------+
3 rows in set

obclient [SYS]> BEGIN;
Query OK, 0 rows affected 

obclient [SYS]> INSERT INTO ordr(id, name, value) VALUES(4,'JP',10004);
Query OK, 1 row affected 

obclient [SYS]> INSERT INTO ordr(id, name, value) VALUES(5,'FR',10005),(6,'RU',10006);
Query OK, 2 rows affected 
Records: 2  Duplicates: 0  Warnings: 0

obclient [SYS]> SELECT * FROM ordr;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 03-NOV-22  |
|  2 | US   | 10002 | 03-NOV-22  |
|  3 | EN   | 10003 | 03-NOV-22  |
|  4 | JP   | 10004 | 03-NOV-22  |
|  5 | FR   | 10005 | 03-NOV-22  |
|  6 | RU   | 10006 | 03-NOV-22  |
+----+------+-------+------------+
6 rows in set

obclient> ROLLBACK;
Query OK, 0 rows affected 

obclient> SELECT * FROM ordr;
+----+------+-------+------------+
| ID | NAME | VALUE | GMT_CREATE |
+----+------+-------+------------+
|  1 | CN   | 10001 | 03-NOV-22  |
|  2 | US   | 10002 | 03-NOV-22  |
|  3 | EN   | 10003 | 03-NOV-22  |
+----+------+-------+------------+
3 rows in set
```

本示例中，通过 `BEGIN` 显示开启了一个事务，在未使用 `COMMIT` 显示提交事务前， 所有修改只对当前会话可见，修改未持久化，可以使用 `ROLLBACK` 语句回滚修改。

### 回滚到某个保存点

下面示例展示了一个事务中包含多个 DML 语句和多个保存点，然后回滚到其中一个保存点，执行后仅丢弃了保存点后面的那部分修改。

1. 查看表当前记录。

   ```sql
   obclient> SELECT * FROM ordr;
   +----+------+-------+------------+
   | ID | NAME | VALUE | GMT_CREATE |
   +----+------+-------+------------+
   |  1 | CN   | 10001 | 01-JAN-70  |
   |  2 | US   | 10002 | 01-JAN-70  |
   |  3 | EN   | 10003 | 01-JAN-70  |
   +----+------+-------+------------+
   3 rows in set
   ```

2. 开启一个事务，设置多个保存点信息。

   ```sql
   obclient> SET session autocommit=off;
   Query OK, 0 rows affected 
   
   obclient> BEGIN;
   Query OK, 0 rows affected 
   
   obclient> INSERT INTO ordr(id, name) VALUES(6,'FR');
   Query OK, 1 row affected 
   
   obclient> SAVEPOINT fr;
   Query OK, 0 rows affected 
   
   obclient> INSERT INTO ordr(id, name) VALUES(7,'RU');
   Query OK, 1 row affected 
   
   obclient> SAVEPOINT ru;
   Query OK, 0 rows affected 
   
   obclient> INSERT INTO ordr(id, name) VALUES(8,'CA');
   Query OK, 1 row affected 
   
   obclient> SAVEPOINT ca;
   Query OK, 0 rows affected
   ```

3. 当前会话能看到事务未提交的所有修改。

   ```sql
   obclient> SELECT * FROM ordr;
   +----+------+-------+------------+
   | ID | NAME | VALUE | GMT_CREATE |
   +----+------+-------+------------+
   |  1 | CN   | 10001 | 01-JAN-70  |
   |  2 | US   | 10002 | 01-JAN-70  |
   |  3 | EN   | 10003 | 01-JAN-70  |
   |  6 | FR   |  NULL | 01-JAN-70  |
   |  7 | RU   |  NULL | 01-JAN-70  |
   |  8 | CA   |  NULL | 01-JAN-70  |
   +----+------+-------+------------+
   6 rows in set
   ```

4. 回滚事务到其中一个保存点。

   ```sql
   obclient> ROLLBACK TO SAVEPOINT ru;
   Query OK, 0 rows affected 
   
   obclient> SELECT * FROM ordr;
   +----+------+-------+------------+
   | ID | NAME | VALUE | GMT_CREATE |
   +----+------+-------+------------+
   |  1 | CN   | 10001 | 01-JAN-70  |
   |  2 | US   | 10002 | 01-JAN-70  |
   |  3 | EN   | 10003 | 01-JAN-70  |
   |  6 | FR   |  NULL | 01-JAN-70  |
   |  7 | RU   |  NULL | 01-JAN-70  |
   +----+------+-------+------------+
   5 rows in set
   ```

   根据查询结果可知，由于 `(8,'CA')` 是在保存点 `ru` 之后插入的数据，回滚后，该修改被丢弃。

5. 提交事务，并确认表的最新修改包含了保存点之前的修改。

   ```sql
   obclient> COMMIT;
   Query OK, 0 rows affected 

   obclient> SELECT * FROM ordr;
   +----+------+-------+------------+
   | ID | NAME | VALUE | GMT_CREATE |
   +----+------+-------+------------+
   |  1 | CN   | 10001 | 01-JAN-70  |
   |  2 | US   | 10002 | 01-JAN-70  |
   |  3 | EN   | 10003 | 01-JAN-70  |
   |  6 | FR   |  NULL | 01-JAN-70  |
   |  7 | RU   |  NULL | 01-JAN-70  |
   +----+------+-------+------------+
   5 rows in set
   ```

## 相关阅读

[事务超时](6.common-errors-and-solutions-for-oracle-mode/1.timeout-errors.md)
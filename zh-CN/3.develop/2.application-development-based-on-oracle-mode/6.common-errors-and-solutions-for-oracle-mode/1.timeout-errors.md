# 超时问题

本文主要介绍超时相关问题的报错信息及处理方法。

## 会话空闲超时报错

### 报错信息

当前会话空闲时间超过指定的阈值时，系统将主动关闭当前连接，并在执行下一次操作时报 `ERROR 2013` 的错误。

例如，当前会话空闲超时后，执行查看 `t1` 表的 SQL 语句时报错。

```sql
obclient [SYS]> SELECT * FROM t1;
ERROR-02013: Lost connection to MySQL server during query
```

### 处理方法

请参考以下步骤查看并修改相关变量的值。

1. 重新连接到对应的 Oracle 租户。

2. 查看变量 `wait_timeout` 的值。

   ```sql
   obclient [SYS]> SHOW VARIABLES WHERE VARIABLE_NAME = 'wait_timeout';
   +---------------------------------+------------------------------+
   | VARIABLE_NAME                   | VALUE                        |
   +---------------------------------+------------------------------+
   | connect_timeout                 | 10                           |
   | default_password_lifetime       | 0                            |
   | error_on_overlap_time           | OFF                          |
   | explicit_defaults_for_timestamp | ON                           |
   | interactive_timeout             | 28800                        |
   | net_read_timeout                | 30                           |
   | net_write_timeout               | 60                           |
   | nls_timestamp_format            | DD-MON-RR HH.MI.SSXFF AM     |
   | nls_timestamp_tz_format         | DD-MON-RR HH.MI.SSXFF AM TZR |
   | ob_pl_block_timeout             | 3216672000000000             |
   | ob_query_timeout                | 10000000                     |
   | ob_trx_idle_timeout             | 86400000000                  |
   | ob_trx_lock_timeout             | -1                           |
   | ob_trx_timeout                  | 86400000000                  |
   | system_time_zone                | +08:00                       |
   | time_zone                       | +8:00                        |
   | timestamp                       | 0                            |
   | wait_timeout                    | 28800                        |
   +---------------------------------+------------------------------+
   18 rows in set
   ```

3. 将变量 `wait_timeout` 的值设置为 `28800`。

   >**说明**
   >
   >变量 `wait_timeout` 用于指定服务器关闭交互式连接前等待活动的秒数。

   ```sql
   obclient [SYS]> SET wait_timeout = 28800;
   Query OK, 0 rows affected
   ```

4. 将 `interactive_timeout` 参数设置为 `28800`。

   >**说明**
   >
   >变量 `interactive_timeout` 用于指定服务器关闭非交互连接之前等待活动的秒数。

   ```sql
   obclient [SYS]> SET interactive_timeout = 28800;
   Query OK, 0 rows affected
   ```

5. 再次查看 `t1` 表，可以正常查询。

   ```sql
   obclient [SYS]> SELECT * FROM t1;
   +----+------+-------+------------------------------+
   | ID | NAME | VALUE | GMT_CREATE                   |
   +----+------+-------+------------------------------+
   |  1 | CN   |  NULL | 12-MAY-22 11.29.49.782106 AM |
   |  2 | UK   |  NULL | 12-MAY-22 11.29.49.782106 AM |
   |  3 | US   |  NULL | 12-MAY-22 11.29.49.782106 AM |
   +----+------+-------+------------------------------+
   3 rows in set
   ```

## 事务超时报错

OceanBase 数据库为了避免事务长时间不提交持有锁影响其他会话，设计了两个超时逻辑，事务空闲超时和事务未提交超时，OceanBase 数据库设计的事务空闲超时和事务未提交超时，分别由租户变量 `ob_trx_idle_timeout` 和 `ob_trx_timeout` 控制，默认值均为 86400000000 微秒，即 24 小时，通常只会有一个超时机制会先被触发。

### 事务空闲超时

事务空闲超时表示事务的两条语句的执行间隔超过了指定的阈值。

**报错信息**

当事务空闲时间超过了指定的阈值时，如果继续执行数据库操作，系统就会报 `ORA-24761` 的错误。

例如，执行 `BEGIN` 语句后，等待一段时间（等待时间超过了事务空闲超时时间阈值），继续执行更新表数据操作时报错。

```sql
obclient [SYS]> CREATE TABLE ordr(
    id number NOT NULL PRIMARY KEY, 
    name varchar(10) NOT NULL, 
    value number, 
    gmt_create timestamp NOT NULL DEFAULT current_timestamp
);
Query OK, 0 rows affected 

obclient [SYS]> INSERT INTO ordr(id, name, value) values(1,'CN',NULL),(2,'UK',NULL),(3,'US',NULL);
Query OK, 3 rows affected 
Records: 3  Duplicates: 0  Warnings: 0

obclient [SYS]> COMMIT;

obclient [SYS]> SELECT * FROM ordr;
+----+------+-------+------------------------------+
| ID | NAME | VALUE | GMT_CREATE                   |
+----+------+-------+------------------------------+
|  1 | CN   |  NULL | 04-NOV-22 06.06.16.843024 PM |
|  2 | UK   |  NULL | 04-NOV-22 06.06.16.843024 PM |
|  3 | US   |  NULL | 04-NOV-22 06.06.16.843024 PM |
+----+------+-------+------------------------------+
3 rows in set

obclient [SYS]> BEGIN; //开启事务
Query OK, 0 rows affected 

<<等待较长时间不操作>>

obclient [SYS]> UPDATE ordr SET value=1003 WHERE id=3;
ORA-24761: transaction rolled back: transaction idle timeout
```

**处理方法**

请参考以下步骤，通过 `ROLLBACK` 回滚事务后，继续操作。

1. 查看变量 `ob_trx_idle_timeout` 的值，确认操作的超时时间是否超过了设置的值。

   事务空闲超时时间阈值由租户变量 `ob_trx_idle_timeout` 控制，单位为微秒，建议使用默认值 24 小时（86400000000 微秒）。

   ```sql
   obclient [SYS]> SHOW VARIABLES LIKE 'ob_trx_idle_timeout';
   +---------------------+-----------+
   | VARIABLE_NAME       | VALUE     |
   +---------------------+-----------+
   | ob_trx_idle_timeout | 120000000 |
   +---------------------+-----------+
   1 row in set
   ```

2. 使用 `ROLLBACK` 回滚事务。

   ```sql
   obclient [SYS]> ROLLBACK;
   Query OK, 0 rows affected
   ```

3. 再次执行更新表数据。

   ```sql
   obclient [SYS]> UPDATE ordr SET value=1003 WHERE id=3;
   Query OK, 1 rows affected
   Rows matched: 1  Changed: 1  Warnings: 0
   ```

### 事务未提交超时

事务未提交超时表示事务超过了指定的阈值仍未提交。

**报错信息**

当事务超过了指定的时间还没有提交时，系统就会报 `ORA-00600` 的错误。

例如，长时间未提交事务或者未回滚后，执行查询表数据的操作时报错。

```sql
obclient [SYS]> CREATE TABLE ordr(
    id number NOT NULL PRIMARY KEY
    , name varchar(10) NOT NULL
    , value number   
    ,gmt_create timestamp NOT NULL DEFAULT current_timestamp);   //准备数据                                                   
Query OK, 0 rows affected

obclient [SYS]> INSERT INTO ordr(id, name, value, gmt_create) VALUES (1,'CN',10001, current_timestamp);
Query OK, 1 row affected 

obclient [SYS]> INSERT INTO ordr(id, name, value) VALUES (2,'US', 10002);
Query OK, 1 rows affected 

obclient [SYS]> INSERT INTO ordr(id, name, value) VALUES (3,'EN', 10003);
Query OK, 1 rows affected 

/* 等待较长一段时间不操作*/

obclient [SYS]> SELECT sysdate, t.* FROM ordr t;
ORA-00600: internal error code, arguments: -6210, Transaction timeout occurred, please rollback the transaction, set the variable ob_trx_timeout to a larger value and then restart the transaction
```

**处理方法**

请参考以下步骤，通过 `ROLLBACK` 回滚并提交事务后，继续操作。

1. 查看 `ob_trx_timeout` 参数值，确认事务超时时间是否超过了设置的值。

   事务的未提交超时时间阈值由租户变量 `ob_trx_timeout` 控制，单位为微秒，建议使用默认值 24 小时（86400000000 微秒）。

   ```sql
   obclient [SYS]> SHOW VARIABLES LIKE 'ob_trx_timeout';
   +----------------+-----------+
   | Variable_name  | Value     |
   +----------------+-----------+
   | ob_trx_timeout | 100000000 |
   +----------------+-----------+
   1 row in set
   ```

2. 使用 `ROLLBACK` 回滚事务。

   ```sql
   obclient [SYS]> ROLLBACK;
   Query OK, 0 rows affected
   ```

3. 再次 `COMMIT`。

   ```sql
   obclient [SYS]> COMMIT;
   Query OK, 0 rows affected
   ```

4. 再次查询 `ordr` 表数据，操作成功。

   ```sql
   obclient [SYS]> SELECT sysdate, t.* FROM ordr t;
   +-----------+----+------+-------+------------------------------+
   | SYSDATE   | ID | NAME | VALUE | GMT_CREATE                   |
   +-----------+----+------+-------+------------------------------+
   | 05-SEP-22 |  1 | CN   | 10001 | 05-SEP-22 04.34.37.145469 PM |
   | 05-SEP-22 |  2 | US   | 10002 | 05-SEP-22 04.34.46.776463 PM |
   | 05-SEP-22 |  3 | EN   | 10003 | 05-SEP-22 04.34.46.776463 PM |
   +-----------+----+------+-------+------------------------------+
   3 rows in set
   ```

## 相关阅读

[事务](../5.transaction.md)
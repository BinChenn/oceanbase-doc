# 约束相关问题

本文主要介绍约束相关问题的报错信息及处理方法。

## 唯一键冲突

当表上有唯一性约束时，再插入相同的记录，数据库就会报错。

### 报错信息

例如，向 `dws_ny` 表中插入数据时，显示主键值 `3` 重复。

```sql
obclient> INSERT INTO dws_ny(id, name, value) VALUES (3,'US', 10003),(4, 'JP', 10004);
ORA-00001: unique constraint '3' for key 'PRIMARY' violated
```

该报错信息对应的错误码信息如下：

* 错误码：ORA-00001

* OceanBase 错误码：5024

* SQLSTATE：23000

关于错误码的详细说明及介绍，请参见 [错误码概述](../../../7.reference/5.system-reference/7.error-code-for-oracle/1.use-error-information.md)。

### 处理方法

1. 查看 `dws_ny` 表中的数据，确认插入的数据是否与主键列的数据重复及现有行数据的取舍。

   ```sql
   obclient> SELECT * FROM dws_ny;
   +----+------+-------+
   | ID | NAME | VALUE |
   +----+------+-------+
   |  1 | CN   | 10001 |
   |  2 | EN   | 10002 |
   |  3 | UK   | 10003 |
   |  4 | JP   | 10004 |
   +----+------+-------+
   4 rows in set
   ```

2. 如果需要保留已存在的行，可以执行以下语句，更新相应 `id=3` 中的数据。

   ```sql
   obclient> UPDATE dws_ny SET name = 'US' WHERE id = 3;
   Query OK, 1 row affected
   ```

   >**说明**
   >
   >* 您也可以通过 `MERGE INTO` 语句来避免唯一键冲突。详细操作步骤，请参见 [替换数据](../3.write-data-for-oracle-mode/4.replace-data.md)。
   >* 如果确定不需要保留已存在的行，可以根据条件将不需要的行删除。具体操作请参见 [删除数据](../3.write-data-for-oracle-mode/3.delete-data.md)。

3. 操作成功后，再次查看 `dws_ny` 表中的数据。

   ```sql
   obclient>  SELECT * FROM dws_ny;
   +----+------+-------+
   | ID | NAME | VALUE |
   +----+------+-------+
   |  1 | CN   | 10001 |
   |  2 | EN   | 10002 |
   |  3 | US   | 10003 |
   |  4 | JP   | 10004 |
   +----+------+-------+
   4 rows in set
   ```

## 外键冲突

添加外键约束时，如果外键的字段与关联字段的类型不匹配时，系统会报错。

### 报错信息

例如，为 `ty` 表创建外键约束时，显示关联字段错误。

```sql
obclient> ALTER TABLE ty ADD CONSTRAINT ty FOREIGN KEY (t_id) REFERENCES tn(name);
ORA-00600: internal error code, arguments: -5317, Cannot add foreign key constraint
```

该报错信息对应的错误码信息如下：

* 错误码：ORA-00600

* OceanBase 错误码：5317

关于错误码的详细说明及介绍，请参见 [错误码概述](../../../7.reference/5.system-reference/7.error-code-for-oracle/1.use-error-information.md)。

### 处理方法

1. 查看 `tn` 表的表结构，确定引用列是否为主键或者唯一键。外键引用列必须为被引用表的唯一键或主键。

   ```sql
   obclient> DESC tn;
   +------------+---------------+------+-----+---------+-------+
   | FIELD      | TYPE          | NULL | KEY | DEFAULT | EXTRA |
   +------------+---------------+------+-----+---------+-------+
   | ID         | NUMBER        | NO   | PRI | NULL    | NULL  |
   | NAME       | VARCHAR2(128) | YES  | NULL | NULL    | NULL |
   | C_DISCOUNT | VARCHAR2(256) | YES  | NULL | '0.99'  | NULL |
   +------------+---------------+------+-----+---------+-------+
   3 rows in set
   ```

2. 选择主键后重新创建外键约束。

   ```sql
   obclient> ALTER TABLE ty ADD CONSTRAINT ty FOREIGN KEY (t_id) REFERENCES tn(id);
   Query OK, 0 rows affected
   ```

# 性能报告

## 版本信息

不同 OCP 版本的性能报告功能可能不同，本节以 OCP V3.3.0 版本为例。

## 架构

OceanBase Analyze Report（以下简称 OBAR ）的目标是提供一款数据库性能分析产品，让用户能够在 OceanBase 发生性能问题的时候，可以通过 OBAR 获取全面的，与性能相关的诊断信息。OBAR 核心目标是需要让用户了解集群或租户的负载和性能情况，同时帮助用户执行一些通用的检查项，最后以报告的形式展现出来。提供报告的形式一方面简化了用户的操作，用户一键操作即可汇总到多维度的系统状态信息，另一方面可以让用户快速了解集群状态，降低用户的使用门槛。

性能报告架构图如下：

![1](http://icms-x-dita.oss-cn-zhangjiakou.aliyuncs.com/xdita-output/zh-CN/task18746956/images/p448643.png?Expires=7258146999&OSSAccessKeyId=LTAIJfoPL6wmrirR&Signature=y8l%2Bna%2FbLluiYUipmpWcL34mvoU%3D)

* OCP 监控采集模块定期采集所需的监控数据，写入 MonitorDB 中：
  
  * OCP server 采集：每小时采集一次，数据存入 ob_hist* 表中。
  * ocp_monagent 采集：每 30 s 采集一次，数据存入 MonitorDB。

* OCP 任务框架定时完成快照点信息统计的功能，该定时任务可以称为 snapshot_producer 。snapshot_producer 负责从监控数据中读取出需要的监控信息，将其加工成快照信息，写入 `ob_hist_*` 表中。为了加快快照统计，会根据监控数据的类型来进行切分任务，利用任务框架子任务的并发执行能力来收集诊断信息。

* 对外提供接口。
  
  * 生成报告。
  
      * 用户指定起始和终止快照点来生成报告。
      * 生成报告的过程需要先进行预检测，如果起始快照点和终止快照点之间存在错误的快照点，则拒绝本次报告生成。另外，如果出现机器上下线也要拒绝生成报告。
      * 预检测通过后，会将当前报告元信息写入到 ob_workload_report 中，当前报告的状态为 '生成中'，等待任务成功或者失败后更新报告的状态为 '成功' 或者 '失败'。
      * 利用本地资源文件和快照数据来生成报告，生成成功的报告会存入 ObjectStorageService 中。
  * 查询、下载报告。
  
      * 从 `ob_workload_report` 中查询报告描述的列表，返回给前端。
      * 从 `ob_workload_report` 中查询出对应的报告描述，并从 ObjectStorageService 中获取到报告内容，返回给前端。

## 报告描述

性能报告包括如下几个部分：基本信息、工作负载统计信息、SQL 统计、锁统计、缓存统计、RPC 统计、参数配置变化等信息。

### 基本信息

下表中的内容可以帮助用户了解集群的资源、节点、租户等基本信息。

|    项目    |                                                           说明                                                            |
|----------|-------------------------------------------------------------------------------------------------------------------------|
| 集群基本信息   | 可查看起始快照点和结束快照点的集群版本、集群类型、主机数量、租户数量、最近一次合并开始时间和最近一次合并结束时间等信息                                                             |
| 节点基本信息   | 可查看主机 IP、所属 Zone、起始快照点和结束快照点是否包含 RS、状态、开始提供服务时间、上次下线时间                                                                  |
| 节点资源信息   | 可查看主机 IP、所属 Zone、CPU 总量（核）、CPU 已分配（核）、CPU 已分配（ % ）、内存总量（ MB ）、内存已分配（ MB )、内存已分配（ % ）、磁盘总量（ GB )、磁盘已使用（GB）、磁盘已使用（ % ）等信息 |
| 节点数据分区信息 | 可查看主机 IP、所属 Zone、关联租户、数据分区数量和 Leader 分区数量等信息。其中数据分区数量包含了 Leader 分区数量                                                    |
| 租户资源信息   | 可查看租户名、租户 ID、租户类型、资源单元配置、Zone 优先级、Locality 和服务器列表等信息                                                                    |
| 租户数据容量信息 | 可查看关联租户、租户 ID、关联主机、数据容量等信息                                                                                              |

### 工作负载统计信息

通过工作负载统计信息可以查看集群级别、租户级别的数据运行负载相关指标的统计信息，提供累计值、开始值、结束值、最大值、最大值出现时间、最小值、最小值出现时间和平均值等信息。

通过这些表格数据，可以得到如下信息：

* `db_time` 表示数据库的工作负载情况。

* `db_cpu` 表示数据库 CPU 执行消耗的时间。非空闲等待所消耗的时间=`db_time` - `db_cpu`。

* 数据库请求的情况，了解 `SELECT`、`INSET`、`DELETE`、`UPDATE` 分别有多少，从而了解业务详情。

* 数据库 SQL 运行是否有优化空间，如果存在大量的远程执行或者分布式执行则可以考虑通过绑定 tablegroup 或者修改分区等方式来进行表定义优化。

* 数据库事务运行状态，如果回滚个数很多，则表示不正常的运行状态，会消耗数据库的资料，则需要调查具体的原因。

* 网络通信情况，接受和发送的网络请求量比较大时，会消耗网络带宽资源，带来额外的费用负担。

具体的指标包括：

|     类型     |          统计项名称          |        描述        |
|------------|-------------------------|------------------|
| SQL 执行个数统计 | sql_select_count        | SELECT语句执行次数     |
| SQL 执行个数统计 | sql_insert_count        | INSERT 语句执行次数    |
| SQL 执行个数统计 | sql_delete_count        | DELECT 语句执行次数    |
| SQL 执行个数统计 | sql_update_count        | UPDATE 语句执行次数    |
| SQL 类型个数统计 | sql_local_count         | 本地 SQL 执行次数      |
| SQL 类型个数统计 | sql_remote_count        | 远程 SQL 执行次数      |
| SQL 类型个数统计 | sql_distributed_count   | 分布式 SQL 执行次数     |
| 数据库时间统计    | db_time                 | 数据库耗时（s）         |
| 数据库时间统计    | db_cpu                  | 数据库 CPU 耗时（s）    |
| 事务相关统计     | transaction_count       | 事务个数             |
| 事务相关统计     | rollbacks               | 事务回滚个数           |
| 事务相关统计     | transaction_rt          | 事务耗时（ms）         |
| 事务相关统计     | rollback_rt             | 事务回滚耗时（ms）       |
| RPC 相关统计   | rpc_packet_in           | 接受到 RPC 请求字节数    |
| RPC 相关统计   | rpc_packet_out          | 发送出去的 RPC 请求字节数  |
| RPC 相关统计   | rpc_packet_in_rt        | 接收到 RPC 请求耗时（ms） |
| 存储层读写统计    | logical_read_row_count  | 逻辑读行数            |
| 存储层读写统计    | physical_read_row_count | 物理读行数            |

### SQL 统计信息

下表按照不同维度来统计 TopSQL，从而知道不同 SQL 对资源的消耗程度。

|         项目         |                                                                         说明                                                                          |
|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| 按照总响应时间排序的 SQL     | <li>收集集群范围内总响应时间 Top10 的 SQL<li> 收集租户范围内总响应时间 Top10 的 SQL          |
| 按照 CPU 时间排序的 SQL   | <li>收集集群范围内 CPU 时间 Top10 的 SQL<li> 收集租户范围内 CPU 时间 Top10 的 SQL      |
| 按照 IO 等待时间排序的 SQL  | <li>收集集群范围内 IO 等待时间 Top10 的 SQL<li> 收集租户范围内 IO 等待时间 Top10 的 SQL    |
| 按照网络等待时间排序的 SQL    | <li>收集集群范围内网络等待时间 Top10 的 SQL<li> 收集租户范围内网络等待时间 Top10 的 SQL        |
| 按照逻辑读行数排序的 SQL     | <li>收集集群范围内逻辑读行数 Top10 的 SQL<li> 收集租户范围内逻辑读行数 Top10 的 SQL          |
| 按照物理读行数排序的 SQL     | <li>收集集群范围内物理读行数 Top10 的 SQL<li> 收集租户范围内物理读行数 Top10 的 SQL          |
| 按照执行次数排序的 SQL      | <li>收集集群范围内执行次数 Top10 的 SQL<li> 收集租户范围内执行次数 Top10 的 SQL            |
| 按照远程计划执行次数排序的 SQL  | <li>收集集群范围内执行次数 Top10 的 SQL<li> 收集租户范围内执行次数 Top10 的 SQL            |
| 按照分布式计划执行次数排序的 SQL | <li>收集集群范围内执行次数 Top10 的 SQL<li> 收集租户范围内执行次数 Top10 的 SQL            |
| 按照影响行数排序的 SQL      | <li>收集集群范围内影响行数 Top10 的 SQL<li> 收集租户范围内影响行数 Top10 的 SQL            |
| 完整的 SQL 文本列表       | 集中展示上述 SQL 语句信息                                                                                                                                     |

### 锁统计信息

|    项目    |                                                                                                                                                                                                                                                                            说明                                                                                                                                                                                                                                                                             |
|----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 行锁统计     | 可查看租户内行锁申请次数、等待次数、超时次数和等待时间等信息                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Latch 统计 | 可查看租户内发生闩锁（ Latch ）的相关统计，统计内容如下： <li>Get：以 Willing-to-wait 类型请求一个 latch 的成功次数<li> Miss：以 Willing-to-wait 类型请求一个 latch 的失败次数   <li>Sleep：以 Willing-to-wait 类型请求一个 latch 失败后进入休眠的次数<li> Spin Get：租户内总共发生 Spin 的次数   <li>Immediate Get：以 Immediate 类型请求一个 latch 成功的次数<li> Immediate Miss：以 Immediate 类型请求一个 latch 不成功的次数    |

### 缓存统计信息

该模块统计租户平均 KV 缓存命中率，统计数据来源于 OceanBase 视图 `gv$systat`，这里统计了 7 大类缓存的统计信息，包括：Block Cache 、Block Index Cache、Clog Cache、Clog Index Cache 、BloomFilter Cache 、Location Cache 和 Row Cache。

不同的 Cache 应用于 SQL 执行的不同阶段，如果某些 Cache 命中率明显很低时，则会给 SQL 的执行效率造成影响，这些信息便是调优的关键信息。

统计信息包括如下内容：

|  参数   |                  说明                   |
|-------|---------------------------------------|
| 缓存命中率 | 快照时间内，各租户不同类型的缓存命中率                   |
| 缓存请求  | 统计快照时间内，各租户的缓存和请求信息，包括请求次数，缓存命中数和未命中数 |
| 缓存大小  | 统计快照期间内，各租户不同类型的缓存大小，包括起止位置           |

### RPC 统计信息

更细粒度的 RPC 通信包的统计，从而了解网络带宽资源消耗情况，帮助用户能够更快捷的进行网络资源不足场景的问题定位。

|         参数         |                                    说明                                    |
|--------------------|--------------------------------------------------------------------------|
| 整体 RPC             | 从租户和主机维度分别统计了 RPC 收发数量及大小、RPC 的网络延迟和发送失败数。并以收发 RPC 大小进行排序，展示 Top10 的统计信息 |
| 包代码 RPC            | 统计并展示按照包代码聚合的 Top10 的 RPC 信息                                             |
| Clog RPC           | 从租户和服务器维度分别统计了 Clog RPC 信息。包含请求次数、成功请求次数、成功请求总耗时                         |
| GTS RPC            | 从租户和服务器维度分别统计了 GTS RPC 数                                                 |
| Location Cache RPC | 从租户和服务器维度分别统计了 Location Cache RPC 信息。包含缓存刷新总次数、RPC 刷新缓存次数、RPC 刷新缓存失败次数   |

### 参数配置变化

该模块统计快照期间，统计不同维度（集群、Zone、服务器和租户）的参数变化情况，包括：参数、参数当前值和修改时间。

了解故障前后的一些参数的变化能让我们更快的掌握集群所发生的变化，排查参数变更引发的故障问题。

## 分区管理

以天为维度进行分区管理，一个分区记录一天的数据，默认提前 8 天（ `ocp.perf.sql.prepare-partition-ahead` ）进行分区创建，根据上表中分区保留时间来进行分区删除。

|           表名           |  分区规则   | 分区保留时间 |  使用模块  |           说明            |
|------------------------|---------|--------|--------|-------------------------|
| ob_hist_snapshot       | monthly | 93 天   | AWR 报告 | 集群快照记录表                 |
| ob_hist_cluster        | monthly | 93 天   | AWR 报告 | 集群基本信息的快照               |
| ob_hist_tenant         | monthly | 93 天   | AWR 报告 | 集群中租户信息的快照              |
| ob_hist_sysstat        | monthly | 93 天   | AWR 报告 | 工作负载信息                  |
| ob_hist_replica        | monthly | 93 天   | AWR 报告 | 副本分布情况                  |
| ob_hist_server         | monthly | 93 天   | AWR 报告 | 集群中 OBServer 信息的快照      |
| ob_hist_row_lock       | monthly | 93 天   | AWR 报告 | 行锁快照                    |
| ob_hist_latch          | monthly | 93 天   | AWR 报告 | Latch 快照                |
| ob_hist_rpc            | monthly | 93 天   | AWR 报告 | 集群 RPC 信息的快照            |
| ob_hist_packet         | monthly | 93 天   | AWR 报告 | 集群 Packet 信息的快照         |
| ob_hist_location_cache | monthly | 93 天   | AWR 报告 | 集群 Location Cache 信息的快照 |
| ob_hist_clog           | monthly | 93 天   | AWR 报告 | 集群 Clog 信息的快照           |
| ob_hist_gts            | monthly | 93 天   | AWR 报告 | 集群 GTS 信息的快照            |
| ob_hist_cache          | monthly | 93 天   | AWR 报告 | 集群缓存信息的快照               |
| ob_hist_parameter      | monthly | 93 天   | AWR 报告 | 集群参数变更历史信息              |
| ob_hist_system_event   | monthly | 93 天   | AWR 报告 | 等待事件记录                  |

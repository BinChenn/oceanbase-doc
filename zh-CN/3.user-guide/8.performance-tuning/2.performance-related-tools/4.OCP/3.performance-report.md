性能报告 
=========================
#docslug#/oceanbase-database/oceanbase-database/V4.0.0/performance-report


背景信息 
-------------------------

不同 OCP 版本的性能报告功能可能不同，本节以 OCP V3.1.0 版本为例。

架构 
-----------------------

OceanBase Analyze Report（以下简称 OBAR ）的目标是提供一款数据库性能分析产品，让用户能够在 OceanBase 发生性能问题的时候，可以通过 OBAR 获取全面的，与性能相关的诊断信息。OBAR 核心目标是需要让用户了解集群或租户的负载和性能情况，同时帮助用户执行一些通用的检查项，最后以报告的形式展现出来。提供报告的形式一方面简化了用户的操作，用户一键操作即可汇总到多维度的系统状态信息，另一方面可以让用户快速了解集群状态，降低用户的使用门槛。

性能报告的架构图如下：

![](https://intranetproxy.alipay.com/skylark/lark/0/2021/png/27456340/1636609481448-f377e76b-7242-44cc-8712-c3728a679320.png)

* 监控采集模块定期采集数据,并写入 MonitorDB 中。

  

* OCP 任务框架定时完成快照点信息统计的功能，该定时任务可以称为 snapshot_producer 。snapshot_producer 负责从监控数据中读取出需要的监控信息，将其加工成快照信息，写入 `ob_hist_*` 表中。为了加快快照统计，会根据监控数据的类型来进行切分任务，利用任务框架子任务的并发执行能力来收集诊断信息。

  

* 对外提供接口。

  




报告描述 
-------------------------

性能报告包括如下几个部分：基本信息、工作负载统计信息、SQL 统计和锁统计等。

### 基本信息 



|    项目    |                                                           说明                                                            |
|----------|-------------------------------------------------------------------------------------------------------------------------|
| 集群基本信息   | 可查看起始快照点和结束快照点的集群版本、集群类型、主机数量、租户数量、最近一次合并开始时间和最近一次合并结束时间等信息                                                             |
| 节点基本信息   | 可查看主机 IP、所属 Zone、起始快照点和结束快照点是否包含 RS、状态、开始提供服务时间、上次下线时间                                                                  |
| 节点资源信息   | 可查看主机 IP、所属 Zone、CPU 总量（核）、CPU 已分配（核）、CPU 已分配（ % ）、内存总量（ MB ）、内存已分配（ MB )、内存已分配（ % ）、磁盘总量（ GB )、磁盘已使用（GB）、磁盘已使用（ % ）等信息 |
| 节点数据分区信息 | 可查看主机 IP、所属 Zone、关联租户、数据分区数量和 Leader 分区数量等信息。其中数据分区数量包含了 Leader 分区数量                                                    |
| 租户资源信息   | 可查看租户名、租户 ID、租户类型、资源单元配置、Zone 优先级、Locality 和服务器列表等信息                                                                    |
| 租户数据容量信息 | 可查看关联租户、租户 ID、关联主机、数据容量等信息                                                                                              |



### 工作负载统计信息 

您可查看集群工作负载统计信息，包括：指标、累计值、开始值、结束值、最大值、最大值出现时间、最小值、最小值出现时间和平均值。

### SQL 统计信息 



|         项目         |                                                                         说明                                                                          |
|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| 按照总响应时间排序的 SQL     | * 收集集群范围内总响应时间 Top10 的 SQL   * 收集租户范围内总响应时间 Top10 的 SQL          |
| 按照 CPU 时间排序的 SQL   | * 收集集群范围内 CPU 时间 Top10 的 SQL   * 收集租户范围内 CPU 时间 Top10 的 SQL      |
| 按照 IO 等待时间排序的 SQL  | * 收集集群范围内 IO 等待时间 Top10 的 SQL   * 收集租户范围内 IO 等待时间 Top10 的 SQL    |
| 按照网络等待时间排序的 SQL    | * 收集集群范围内网络等待时间 Top10 的 SQL   * 收集租户范围内网络等待时间 Top10 的 SQL        |
| 按照逻辑读行数排序的 SQL     | * 收集集群范围内逻辑读行数 Top10 的 SQL   * 收集租户范围内逻辑读行数 Top10 的 SQL          |
| 按照物理读行数排序的 SQL     | * 收集集群范围内物理读行数 Top10 的 SQL   * 收集租户范围内物理读行数 Top10 的 SQL          |
| 按照执行次数排序的 SQL      | * 收集集群范围内执行次数 Top10 的 SQL   * 收集租户范围内执行次数 Top10 的 SQL            |
| 按照远程计划执行次数排序的 SQL  | * 收集集群范围内执行次数 Top10 的 SQL   * 收集租户范围内执行次数 Top10 的 SQL            |
| 按照分布式计划执行次数排序的 SQL | * 收集集群范围内执行次数 Top10 的 SQL   * 收集租户范围内执行次数 Top10 的 SQL            |
| 按照影响行数排序的 SQL      | * 收集集群范围内影响行数 Top10 的 SQL   * 收集租户范围内影响行数 Top10 的 SQL            |
| 完整的 SQL 文本列表       | 集中展示上述 SQL 语句信息                                                                                                                                     |



### 锁统计信息 



|    项目    |                                                                                                                                                                                                                                                                            说明                                                                                                                                                                                                                                                                             |
|----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 行锁统计     | 可查看租户内行锁申请次数、等待次数、超时次数和等待时间等信息                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Latch 统计 | 可查看租户内发生闩锁（ Latch ）的相关统计，统计内容如下： * Get：以 Willing-to-wait 类型请求一个 latch 的成功次数   * Miss：以 Willing-to-wait 类型请求一个 latch 的失败次数   * Sleep：以 Willing-to-wait 类型请求一个 latch 失败后进入休眠的次数   * Spin Get：租户内总共发生 Spin 的次数   * Immediate Get：以 Immediate 类型请求一个 latch 成功的次数   * Immediate Miss：以 Immediate 类型请求一个 latch 不成功的次数    |



配置参数 
-------------------------

### 分区管理 

以天为维度进行分区管理，一个分区记录一天的数据，默认提前 8 天（ `ocp.perf.sql.prepare-partition-ahead` ）进行分区创建，根据上表中分区保留时间来进行分区删除。

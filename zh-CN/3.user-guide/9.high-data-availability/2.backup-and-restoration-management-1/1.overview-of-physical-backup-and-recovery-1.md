# 物理备份与恢复概述

#docslug#/oceanbase-database/oceanbase-database/V4.0.0/overview-of-physical-backup-and-recovery-1
备份恢复是 OceanBase 数据库高可用特性的核心组件，主要用于保障数据的安全，包括预防存储介质损坏和用户的错误操作等。如果存储介质损坏或者用户误操作而导致了数据丢失，可以通过恢复的方式恢复用户的数据。

## 概述

备份恢复是 OceanBase 数据库高可用特性的核心组件，主要用于保障数据的安全，包括预防存储介质损坏和用户的错误操作等。如果存储介质损坏或者用户误操作而导致了数据丢失，可以通过恢复的方式恢复用户的数据。

目前 OceanBase 数据库支持 OSS 和 NFS 两种备份介质，提供了备份、恢复、管理三大功能。

OceanBase 数据库支持租户级别的物理备份。物理备份由基线数据、日志归档数据两种数据组成，因此物理备份由日志归档和数据备份两个功能组合而成：

* 日志归档是指日志数据的自动归档功能，OBServer 会定期将日志数据归档到指定的备份路径。这个动作是全自动的，不需要外部定期触发。

* 数据备份指的是备份基线数据的功能，该功能分为全量备份和增量备份两种：

  * 全量备份是指备份所有的需要基线的宏块。

  * 增量备份是指备份上一次备份以后新增和修改过的宏块。

OceanBase 数据库支持租户级目录的恢复。

OceanBase 数据库还支持自动清理过期的备份。

## 备份恢复相关的基础概念

* ObTablet（分片）：静态数据和动态数据的载体，具有实体结构。

* ObTabletMgr：管理一组分片的实体结构。

* 日志流副本（ObLogStream）：所有数据的载体，包含了日志和数据。

* 日志流（LogStream，简称 LS）：多个日志流副本组成一个日志流。

* 分区（Partition，简称 PT）：分区是一个逻辑结构，其代表一个 tablet 或者多个 tablet。

## 物理备份架构

OceanBase 数据库物理备份的架构如下图所示。

![备份架构](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/5307748161/p264263.png)

当租户登录到备份集群以后，需要先发起日志归档，待日志归档发起完成启动阶段以后，才可以发起基线备份。

日志归档是定期备份到备份目的端的，只需要用户发起一次 `alter system archivelog`，日志备份就会在后台持续进行。日志归档是由每个 PG（PartitionGroup）的 Leader 负责定期将该 PG 的日志归档到备份介质指定的路径，RS（RootService）负责定期统计日志归档的进度，并更新到内部表。

数据备份以日志流为单位进行备份。以下文档中，日志流（LogStream）简称 LS，Partition 简称 PT。

数据备份流程如下：

1. 用户发起数据备份。

2. RS 记录当前租户的 GTS 为 `t1`，作为本次备份的起始位点。

3. RS 获取 LS 级别的 PT 列表，以此生成备份的任务，记录到 LSG 的备份目录。

4. RS 调度 OBServer 执行指定的 LS 的备份任务。

   这里的 OBServer 是满足配置项 `backup_zone` 限制的 OBServer，如果用户指定备份的 Zone 列表内有包含 LS 的 OBServer，则优先调度该 OBServer；如果没有，则调度空闲的 OBServer 远程备份 LS。

5. RS 等待所有的 LS 备份完成，记录备份完成的 GTS 为 `t2`，作为本次备份的结束位点。

   如果有 LS 在备份的时候失败了，则需要重新从第 2 步开始再执行一遍流程。

6. 如果是指定路径的备份，则 RS 会生成每个 LS 需要的日志补偿任务，每个 LS 将恢复到 `t2` 时刻依赖的日志单独保存到数据备份的路径上。

   这个步骤是为了保证数据备份可以独立的恢复到结束的 `t2` 位点，而不依赖全量的日志备份。

7. RS 等待所有的日志补偿任务完成，将 `t2` 记录为本次数据备份的可以恢复的起始位点。

## 物理恢复架构

OceanBase 数据库的物理恢复架构如下图所示。

![恢复架构](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/5307748161/p264265.png)对于用户可见的流程主要有两步：

1. 在目的集群上用 `CREATE RESOURCE POOL`命令建立恢复租户需要的资源池。

2. 通过 `ALTER SYSTEM RESTORE TENANT` 命令调度租户恢复任务。

   对于备份恢复来说，`RESTORE TENANT` 命令的内部流程如下：

   1. 创建恢复用的租户。

   2. 恢复租户的系统表数据。

   3. 恢复租户的系统表日志。

   4. 调整恢复租户的元信息。

   5. 恢复租户的用户表数据。

   6. 恢复租户的用户表日志。

   7. 恢复扫尾工作。

      对于单个 PG 来说，恢复的流程就是将 PG 的元信息和宏块数据拷贝到指定的 OBServer，构建出一个只有基线数据的 PG；然后再把 PG 的日志拷贝到指定的 OBServer，回放到该 PG 的 MemTable 中。这个流程中如果日志的量比较大，可能会触发转储操作。

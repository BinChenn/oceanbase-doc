注意事项及使用限制 
==============================

本节主要介绍主备库功能的注意事项及使用限制。

注意事项 
-------------------------

* 备集群不能主动触发大版本冻结

  备集群同步了主集群的 Major Freeze 冻结信息，只有主集群才能发起 Major Freeze 操作，备集群根据主集群的冻结信息调度合并操作。但是备集群可以自己触发 Minor Freeze，与主集群无关。

  如果备集群的大版本信息同步落后，可能会导致备集群的系统租户同步卡住。
  

* 备集群不能落后太多

  备集群长时间落后的情况下，内部会自动执行重建操作拉取主集群上的全量数据，然后从最新的日志点开始同步日志。这个过程会导致内部多版本数据空洞，从而导致 Failover 失败和备集群读失败，待备集群追上主集群后即可恢复服务。

  为了让备集群能够在重建的情况下执行有损 Failover，您可以在主集群的每个普通租户下设置系统变量 `undo_retention`，保证多版本数据保留特定的时间，系统变量 `undo_retention` 的更多信息请参见 [undo_retention](/zh-CN/13.reference-oracle-mode/2.system-variable-6/133.undo_retention-1-2-3-4.md)。

  例如，您在主集群的普通租户下执行以下命令，则表示无论是否执行了重建，备集群在落后半小时之内均可以执行 Failover。

  ```sql
  obclient> SET GLOBAL undo_retention = 1800;
  ```

  




使用限制 
-------------------------



|                   限制项                   |                                                                                                                                                                                                                                                                                                                                                                                            描述                                                                                                                                                                                                                                                                                                                                                                                             |
|-----------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 集群级同步                                   | 支持主备库按集群同步数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 租户级同步                                   | 不支持主备库按租户同步数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 备集群个数限制                                 | 31 个                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 备集群系统租户 DDL 个数限制                        | 小于每秒 500 个                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 配置项是否同步                                 | 在主集群上修改配置项不影响备集群                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 普通租户的系统变量是否同步                           | 在主集群上修改普通系统变量会同步到备集群                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 主集群表级别或者数据库级别设置 Locality 和 Primary Zone | 不支持                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 主集群租户级别设置 Locality 和 Primary Zone       | 支持                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 支持的副本类型                                 | * 支持全能型、日志型、只读型、加密投票型副本   * 不支持 Locality 混布                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 升级模式                                    | 支持从 V2.2.60 及之后的版本滚动升级                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| GTS 开关限制                                | 所有普通租户均开启 GTS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 分布式事务一阶段优化限制                            | 主集群和备集群的一阶段优化开关 `enable_one_phase_commit` 关闭                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Schema 对象限制                             | 支持复制表，但不能设置表级别的 Locality                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 添加备集群限制                                 | * 升级后需要合并一轮才能接入备集群   * 要求备集群是空集群   * 要求主集群不能有处于分裂的表   * 要求主集群不能有非 Tenant 级别的 Locality、Primary Zone 等信息   * 要求主集群不处于升级阶段   * 要求备集群的 OceanBase 数据库版本与主集群版本一致   * 要求 Schema 删除的副本全部 GC   * 所有普通租户必须打开 GTS 开关   * 要求主集群关闭一阶段优化开关 `enable_one_phase_commit`                                                                                                                                                                                                          |
| Switchover 限制                           | * 主、备集群要求所有 Server 在线   * 不能出现合并 Error   * Switchover 过程中停写，旧的主集群会最终返回 `4688` 或者超时   * 如果切换时间超过配置项 `max_stale_time_for_weak_consistency`（默认为 5 秒）的限制，则备集群停止弱一致性读服务   * 备集群上的 `enable_rereplication` 配置项要求打开，否则不能执行 Switchover 操作   * 一主多备的场景，需要所有备集群都在线，不在线的备集群必须处于 `DISABLED` 状态   * 要求主备集群的版本号一致   * 要求主集群不能处于物理备份中   * 要求没有 Restore 状态的副本   * 最大保护模式下主集群的日志传输模式是 `SYNC`   * 要求不能处于升级过程中    |
| Failover 限制                             | * 支持最大性能模式 Failover   * 支持最大保护模式 Failover   * 支持最大可用模式 Failover   * 有损 Failover 要求所有 Server 在线   * 执行 Failover 后，要求完成一轮合并才能接入备集群                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 保护模式限制                                  | * 支持最大性能、最大保护和最大可用模式   * 最大保护模式和最大可用模式下的备集群配置限制： * 有且仅有一个 `SYNC` 模式的备集群   * 不能修改 `SYNC` 模式的备集群，包括删除和 Disable 操作   * 不能修改 `SYNC` 模式的备集群的日志传输模式为 `ASYNC`     * 最大保护模式和最大可用模式下的 Switchover 操作限制： * 只能选择 `SYNC` 模式的备集群切换为主集群   * 要求当前主集群的日志传输模式配置为 `SYNC`，保证主备切换完成之后，继续进入最大保护模式                                                                                                                                                  |
| 物理备份恢复限制                                | * 带备集群的情况下，主集群不支持执行恢复   * 备集群不支持备份和日志归档   * 不支持物理恢复一个备集群   * 主集群物理恢复一个租户后，要求合并一轮后才能添加备集群                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 解耦备集群限制                                 | * 要求集群角色为备集群（`PHYSICAL STANDBY`）。   * 要求备集群的所有 Server 均在线。   * 要求主集群不处于升级阶段。   * 支持执行解耦命令的 Switchover 状态为，`NOT ALLOWED`、`TO PRIMARY` 和 `DISCONNECT`。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |



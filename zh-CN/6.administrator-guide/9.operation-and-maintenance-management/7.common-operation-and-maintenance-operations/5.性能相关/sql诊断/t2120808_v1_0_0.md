SQL 诊断 
===========================

SQL 问题是性能问题中最常见的一类。OCP 的 SQL 诊断功能根据 SQL 特征将 SQL 归类为可疑 SQL、TopSQL 和 SlowSQL，便于您分析。并提供索引绑定功能，在线优化 SQL。

**操作步骤** 
-----------------------------

1. 在左导航栏单击 **租户** ，并在 **租户列表** 中单击具体的租户进入租户 **总览** 页面。

   

2. 在左侧导航栏单击 **SQL 诊断** ，进入 **SQL 诊断** 页面。

   若集群参数 enable_sql_audit、enable_perf_event 和租户参数 ob_enable_sql_audit 中任何一个未配置成打开，则 **SQL 诊断** 页面将缺失 SQL 诊断数据。可通过提示中的按钮修改参数值。
   ![08251800](http://icms-x-dita.oss-cn-zhangjiakou.aliyuncs.com/xdita-output/zh-CN/task14977521/images/p312497.png?Expires=7258146978&OSSAccessKeyId=LTAIJfoPL6wmrirR&Signature=32MtEb3oWaww0OoFuUUkquFVfKs%3D)

3. SQL 诊断根据运行特征将 SQL 分为可疑 SQL、TopSQL 和 SlowSQL。可疑 SQL 为性能下降和执行计划发生变化的 SQL，DBA 需要重点关注。可疑 SQL 的诊断结果包含性能下降的原因分析。SlowSQL 将响应时间超过 100ms 的 SQL 进行展示。TopSQL 将全量 SQL 根据平均响应时间进行排序展示。

   

4. 可以对可疑 SQL/TopSQL/SlowSQL 进行筛选。

   1. 配置筛选条件

      * 时间范围：可在 **时间范围** 下拉框中选择 近 5 分钟、近 10 分钟、近 20 分钟、近 30 分钟、近 1 小时、近 3 小时来快速选择时间范围；也可在下拉框中选择自定义时间，并配置开始时间和结束时间。默认显示近 30 分钟内的信息。

        
      
      * OBServer：选择 OBServer，查询时将只查询在该 OBServer 上执行的 SQL。

        
      
      * 内部 SQL：若勾选，则查询结果中会包含由 OceanBase 内部发起的 SQL。

        
      
      * 关键词：查询结果中会显示 SQL 文本中包含该关键词的 SQL。

        
      
      * 高级搜索：下拉框中选择 **SQL ID、执行次数、每秒执行次数** 等指标，并配置指标值，查询时将获取指标满足条件的 SQL 展示在查询结果列表中。

        
      

      ![08251824](http://icms-x-dita.oss-cn-zhangjiakou.aliyuncs.com/xdita-output/zh-CN/task14977521/images/p312510.png?Expires=7258146978&OSSAccessKeyId=LTAIJfoPL6wmrirR&Signature=cecPnn30bApdJVx0Yr2GL9Dfe1Y%3D)
   
   2. 单击 **查询** ，下方列表中将展示所有符合查询条件的 SQL。

      
   

   

5. 单击 **导出可疑SQL** 、 **导出 TopSQL** 、 **导出SlowSQL** 按钮，将导出列表中展示的所有 SQL。

   




# 重启节点

重启节点是通过一系列操作将节点停止后再重新启动的一个过程。

## 操作前须知

为了避免影响正在运行的业务，重启节点推荐按照以下操作顺序来执行：

1. 停止节点服务。

2. 对节点进行转储操作，以便加速重启。

3. 停止 observer 进程。

4. 启动 observer 进程。

5. 启动节点服务。

## 重启节点

本文以重启集群中的一个节点为例提供操作指导，如果需要重启多个节点，请参考本操作执行多次即可。

1. 使用 `root` 用户登录到数据库的 `sys` 租户。

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   [admin@xxx oceanbase]$ obclient -h10.xx.xx.xx -P2883 -uroot@sys -p***** -A
   ```

2. 执行以下命令，停止节点服务。

   ```sql
   obclient [none]> ALTER SYSTEM STOP SERVER 'SVR_IP:SVR_PORT';
   ```

   其中：

   * `SVR_IP`：表示待停止的节点所在的主机 IP。

   * `SVR_PORT`：表示待停止的节点主机的 RPC 端口。

   示例如下：

   ```sql
   obclient [none]> ALTER SYSTEM STOP SERVER 'xx.xx.xx.10:2882';
   ```

   执行成功后，可以查询 `oceanbase.DBA_OB_SERVERS` 视图中该 Server 的 `STATUS` 字段，字段值仍为 `ACTIVE` 不变，但 `STOP_TIME` 字段的值由 `NULL` 变为停止服务的时间点。

3. 执行以下命令，对待重启的节点进行转储操作。

   ```sql
   obclient [none]> ALTER SYSTEM MINOR FREEZE SERVER = ('SVR_IP:SVR_PORT');
   ```

   其中：

   * `SVR_IP`：表示待重启的节点所在的主机 IP。

   * `SVR_PORT`：表示待重启的节点主机的 RPC 端口。

   示例如下：

   ```sql
   obclient [none]> ALTER SYSTEM  MINOR FREEZE SERVER = ('xx.xx.xx.10:2882');
   ```

4. 停止 observer 进程。

   1. 使用 `admin` 用户登录待停止进程的节点所在的机器。

   2. 通过命令行工具进入 `/home/admin/oceanbase/bin` 目录。

       ```bash
       [admin@xxx oceanbase]$ cd /home/admin/oceanbase/bin
       ```

   3. 执行以下命令，查看并获取节点的进程 ID。

      ```bash
      [admin@xxx oceanbase]$ ps -ef | grep observer | grep -v grep
      ```

   4. 停止 observer 进程。

      ```bash
      [admin@xxx oceanbase]$ kill -15 pid
      ```

      其中，`pid` 为待停止的节点的 observer 进程 ID。

      示例如下：

      ```bash
      [admin@xxx oceanbase]$ kill -15 6136
      ```

      如果进程停止失败，可以执行 `kill -9 pid` 命令强制停止该进程。

   5. 执行以下命令，确认进程是否已停止。

       ```bash
       [admin@xxx oceanbase]$ ps -ef | grep observer | grep -v grep
       ```

       如果命令执行后没有返回信息，则表示进程停止成功。

5. 启动 observer 进程。

   1. 使用 `admin` 用户登录待停止进程的节点所在的机器。

   2. 通过命令行工具进入 `/home/admin/oceanbase/bin` 目录。

       ```bash
       [admin@xxx oceanbase]$ cd /home/admin/oceanbase/bin
       ```

   3. 启动 observer 进程。

      ```bash
      [admin@xxx oceanbase]$ ./bin/observer
      ```

   4. 进程启动后，5~10 秒钟后，执行以下命令，确认进程是否启动成功。

      ```bash
      [admin@xxx oceanbase]$ ps -ef | grep observer | grep -v grep
      admin       6136      0 99 11:23 ?        00:00:19 ./bin/observer
      ```

      示例中，命令执行后有返回信息，表示进程已启动成功。如果命令执行后没有返回信息，则表示进程启动失败。

   5. 执行以下命令，确认端口监听是否成功。

      ```bash
      [admin@xxx oceanbase]$ netstat -ntlp | grep `pidof observer`
      tcp        0      0 0.0.0.0:2881            0.0.0.0:*               LISTEN      6136/./bin/observer
      tcp        0      0 0.0.0.0:2882            0.0.0.0:*               LISTEN      6136/./bin/observer
      ```

      示例中，`6136/./bin/observer` 中的 `6136` 表示 observer 的进程 ID，从执行结果可知，端口监听成功。

6. 执行以下命令，启动节点服务。

   ```sql
   obclient [none]> ALTER SYSTEM START SERVER 'SVR_IP:SVR_PORT';
   ```

   其中：

   * `SVR_IP`：表示待停止的节点所在的主机 IP。

   * `SVR_PORT`：表示待停止的节点主机的 RPC 端口。

   示例如下：

   ```sql
   obclient [none]> > ALTER SYSTEM START SERVER 'xx.xx.xx.10:2882';
   ```

   执行成功后，可以查询 `oceanbase.DBA_OB_SERVERS` 视图中的 `START_SERVICE_TIME` 字段，该字段表示节点启动服务的时间。如果该值为 `NULL`，则表示该节点的服务还没有启动。

# 增加节点

当集群中的资源不够时，您可以通过增加节点来扩容。

## 背景信息

增加节点即是增加 OBServer 服务器。增加节点有以下两种场景：

* 向已存在的 Zone 中增加 OBServer

* 添加 zone 并向该 Zone 中增加 OBServer

## 前提条件

* 请确认待增加的所有 OBServer 服务器已完成相关配置，具体操作可参见 [服务器配置](../../../4.deploy/3.preparations-before-deployment-1/2.server-configuration.md) 章节和 [部署环境配置](../../../../4.deploy/6.command-line-deployment/1.configure-a-deployment-environment-2/1.install-oat-cli.md)章节。

* 对于需要增加 Zone 再向该 Zone 中增加 OBServer 节点的场景，请确认已增加 Zone，增加 Zone 的操作请参见 [增加 Zone](5.add-a-zone.md)。

* 增加节点前需要为所有 OBServer 服务器安装数据库软件，请确认已从部署人员处获取对应版本的 OceanBase 数据库软件安装包。

## 安装软件并创建目录

完成基本装机后，在增加节点前，需要为待增加的所有 OBServer 服务器安装数据库软件和创建目录。

1. 使用 `admin` 用户登录到待增加的 OBServer 服务器上。

2. 安装 OceanBase 数据库的 RPM 包。

   其中，`rpm_dir` 表示存放 RPM 包的目录；`$rpm_name` 表示 RPM 包的名称。

   ```shell
   [root@hostname /]# cd $rpm_dir
   
   [root@hostname $rpm_dir]# rpm -i --prefix=/home/admin/oceanbase $rpm_name
   ```

3. 在待增加的 OBServer 服务器上创建 `/data/1` 和 `/data/log1` 目录，并将目录的拥有者（Owner）修改为 `admin`。

   通常情况下，使用 `/data/1` 作为数据目录，`/data/log1` 作为日志目录。

   ```shell
   [root@xxx /]# mkdir -p /data/1 /data/log1
   [root@xxx /]# cd data
   [root@xxx data]# ll
   total 8
   drwxr-xr-x 2 root root 4096 Nov 18 14:24 1
   drwxr-xr-x 2 root root 4096 Nov 18 14:24 log1
   [root@xxx data]# cd ..
   [root@xxx /]# chown -R admin:admin data
   [root@xxx /]# cd data
   [root@xxx data]# ll
   total 8
   drwxr-xr-x 2 admin admin 4096 Nov 18 14:24 1
   drwxr-xr-x 2 admin admin 4096 Nov 18 14:24 log1
   ```

4. 初始化 OceanBase 数据库的目录。

   OceanBase 数据库的数据目录通常建议设置在独立的磁盘上，然后通过软链接方式链接到软件的 `Home` 目录下面。

   ```shell
   [root@xxx admin]# su - admin
   -bash-4.2$ mkdir -p /data/1/$cluster_name/{etc3,sort_dir,sstable,slog} 
   -bash-4.2$ mkdir -p /data/log1/$cluster_name/{clog,etc2,ilog,oob_clog} 
   -bash-4.2$ mkdir -p /home/admin/oceanbase/store/$cluster_name
   -bash-4.2$ for t in {etc3,sort_dir,sstable,slog};do ln -s /data/1/$cluster_name/$t /home/admin/oceanbase/store/$cluster_name/$t; done
   -bash-4.2$ for t in {clog,etc2,ilog,oob_clog};do ln -s /data/log1/$cluster_name/$t /home/admin/oceanbase/store/$cluster_name/$t; done
   ```

   其中，`cluster_name` 表示待添加 OBServer 节点的集群名。

   示例如下：

   ```shell
   [root@xxx admin]# su - admin
   -bash-4.2$ mkdir -p /data/1/obdemo/{etc3,sort_dir,sstable,slog} 
   -bash-4.2$ mkdir -p /data/log1/obdemo/{clog,etc2,ilog,oob_clog} 
   -bash-4.2$ mkdir -p /home/admin/oceanbase/store/obdemo
   -bash-4.2$ for t in {etc3,sort_dir,sstable,slog};do ln -s /data/1/obdemo/$t /home/admin/oceanbase/store/obdemo/$t; done
   -bash-4.2$ for t in {clog,etc2,ilog,oob_clog};do ln -s /data/log1/obdemo/$t /home/admin/oceanbase/store/obdemo/$t; done
   ```

5. 重复以上操作，直至所有 OBServer 服务器全部操作完成。

## 增加节点

本示例中以向 Zone4 中添加 3 台 OBServer 为例提供操作指导。

1. 启动 OBServer。

   1. 以 `admin` 用户登录到任意一台待增加的 OBServer 服务器上。

   2. 执行以下命令，启动 OBServer。

      语句如下：

      ```sql
      [admin@xxx oceanbase]$ /home/admin/oceanbase/bin/observer -i eth0 -P xxxx -p xxxx -z zone_name -d /home/admin/oceanbase/store/cluster_name -r 'SVR_IP:SVR_PORT:SQL_PORT;SVR_IP:SVR_PORT:SQL_PORT;SVR_IP:SVR_PORT:SQL_PORT' -c cluster_id -n cluster_name -o "memory_limit_percentage=90,memstore_limit_percentage=60,datafile_disk_percentage=80,config_additional_dir=/data/1/cluster_name/etc3;/data/log1/cluster_name/etc2"
      ```

      相关参数说明如下：

      * `-P`：用于指定 RPC 端口号。
      * `-p`：用于指定直连端口号。
      * `-z`：用于指定待增加的 OBServer 所属的 Zone。
      * `-d`：用于指定数据的存储目录。
      * `-r`：用于指定待增加的 OBServer 的 IP 地址列表。
      * `-c`：用于指定集群 ID。
      * `-n`：用于指定集群名。
      * `-o`：用于指定集群的启动配置项。

      >**注意**
      >
      >在启动 OBServer 时，请务必指定正确的 Zone 名称和初始化参数值。

      示例如下：

      ```sql
      obclient> /home/admin/oceanbase/bin/observer -i eth0 -P 2882 -p 2881 -z zone4 -d /home/admin/oceanbase/store/obdemo -r 'xx.xx.xx.10:2882:2881;xx.xx.xx.11:2882:2881;xx.xx.xx.12:2882:2881' -c 20190716 -n obdemo -o "memory_limit_percentage=90,memstore_limit_percentage=60,datafile_disk_percentage=80,config_additional_dir=/data/1/obdemo/etc3;/data/log1/obdemo/etc2"
      ```

2. 向集群中添加节点。

   1. 使用 `root` 用户登录到数据库的 `sys` 租户。

      连接示例如下，连接数据库时请以实际环境为准。

      ```shell
      [admin@xxx oceanbase]$ obclient -h10.xx.xx.xx -P2883 -uroot@sys -p***** -A
      ```

   2. 执行以下命令，向集群中添加节点。

      ```sql
      obclient [none]> ALTER SYSTEM ADD SERVER 'SVR_IP:SVR_PORT;SVR_IP:SVR_PORT;SVR_IP:SVR_PORT' ZONE 'zone_name';
      ```

      其中：

      * `SVR_IP`：表示待添加的 OBServer 的 IP。

      * `SVR_PORT`：表示待添加的 OBServer 的 RPC 端口。默认为 `2882`。

      * `zone_name`：表示待添加节点的 Zone。

      示例如下：

      ```sql
      obclient [none]> ALTER SYSTEM ADD SERVER 'xx.xx.xx.10:2882;xx.xx.xx.11:2882;xx.xx.xx.12:2882' ZONE 'zone4';
      ```

      该操作会将 OBServer 加入到服务列表，只有服务列表中的 OBServer 才可以提供服务。

3. 执行成功后，可以查询 `oceanbase.DBA_OB_SERVERS` 视图进行确认。

   查询示例如下：

   ```sql
   obclient [none]> SELECT * FROM oceanbase.DBA_OB_SERVERS;
   ```

   列表中有刚才添加的 OBServer，则表示添加成功。

# 隔离节点

当前节点异常或节点运维变更时，需要先隔离节点，将流量切到其他节点，以免业务受到影响。

## 隔离命令

隔离节点有以下三种方式：

* 通过 `STOP SERVER` 命令隔离节点

* 通过 `FORCE STOP SERVER` 命令隔离节点

* 通过 `ISOLATE SERVER` 命令隔离节点

### `STOP SERVER` 命令

假设被执行 `STOP SERVER` 命令的节点为 A，`STOP SERVER` 命令内部的执行逻辑如下：

* 检查除去 A 上的分区副本外，其他剩余副本是否依然能形成多数派。如果剩余副本不能形成多数派，则不允许对 A 执行 `STOP SERVER`操作。

* 检查集群内的所有分区副本的 CLog 的 `is_in_sync` 状态是否为 `1`。如果存在任意 `is_in_sync` 状态为 `0` 的副本，不允许对 A 执行 STOP SERVER 操作。

* 以上两个条件检查通过后，设置 A 的节点状态为 `stopped`，并等待 A 上的 Leader 全部切走，然后给客户端返回成功。

对于 Stop Server 成功的节点，可以执行任意运维动作而不影响业务流量，例如执行重启节点操作。

### `FORCE STOP SERVER` 命令

假设被执行 `FORCE STOP SERVER` 命令的节点为 B，`FORCE STOP SERVER` 命令内部的执行逻辑如下：

* 检查除去 B 上的分区副本外，其他剩余副本是否依然能形成多数派。如果剩余副本不能形成多数派，则不允许对 B 执行 force stop server 操作。

* 以上条件检查通过后，设置 B 的节点状态为 stopped，并等待待 B 上的 Leader 全部切走，然后给客户端返回成功。

### `ISOLATE SERVER` 命令

假设被执行 `ISOLATE SERVER` 命令的节点为 C，`ISOLATE SERVER` 命令内部的执行逻辑如下：

不对 C 做任何条件检查，仅将 C 的节点状态在 RS 端标记为 stopped，然后给客户端返回成功。

## 隔离节点

在对节点进行异常隔离或者运维操作时，可以使用如下递进方式进行处理：

1. 使用 `root` 用户登录到数据库的 `sys` 租户。

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   [admin@xxx oceanbase]$ obclient -h10.xx.xx.xx -P2883 -uroot@sys -p***** -A
   ```

2. 对问题节点执行 Stop Server 操作。

   语句如下：

   ```sql
   ALTER SYSTEM STOP SERVER 'ip:port'; 
   ···

   成功执行后，可以对节点做任何运维操作，可以直接 kill observer 进程，对业务流量无任何影响。若无法执行成功，尝试执行 Force Stop Server 操作。

3. 对问题节点执行 Force Stop Server 操作。

   ```sql
   ALTER SYSTEM FORCE STOP SERVER 'ip:port'; 
   ```

   成功执行后可以对节点做任何运维操作，可以直接 kill observer 进程，对业务流量无任何影响。若无法执行成功，尝试执行 Isolate Server 操作。

4. 对问题节点执行 Isolate Server 操作。

   ```sql
   ALTER SYSTEM ISOLATE SERVER 'ip:port'; 
   ```

   成功执行 Isolate Server 操作 后，仅表示该节点为 stopped 状态，RS 会尽力将问题节点上的 Leader 切走，此时不能直接 kill observer 进程。如果 kill observer 进程，可能有如下问题：

   * 集群中所有分区副本完好，但问题节点上存在Leader，kill server后出现部分分区副本无主选举，短时间影响业务流量。

   * 集群中存在部分分区已经缺副本，但依然能够达成多数派，kill server后导致部分分区无法形成多数派，这些分区在kill server后会长时间无主，长时间影响业务流量。

5. 使用 `kill -9 pid` 命令 Kill observer 进程。

   本操作务必要谨慎，可能会产生如下严重影响：

   * 集群中所有分区副本完好，但问题节点上存在 Leader，kill server 后出现部分分区副本无主选举，短时间影响业务流量。

   * 集群中存在部分分区已经缺副本，但依然能够达成多数派，kill server 后导致部分分区无法形成多数派，这些分区在 kill server 后会长时间无主，长时间影响业务流量。

   具体操作如下：

   1. 使用 `admin` 用户登录待停止进程的节点所在的机器。

   2. 通过命令行工具进入 `/home/admin/oceanbase/bin` 目录。

       ```bash
       [admin@xxx oceanbase]$ cd /home/admin/oceanbase/bin
       ```

   3. 执行以下命令，查看并获取节点的进程 ID。

      ```bash
      [admin@xxx oceanbase]$ ps -ef | grep observer | grep -v grep
      ```

   4. Kill observer 进程。

      ```sql
      [admin@xxx oceanbase]$ kill -9 pid
      ```

## 相关文档

* [查看节点](../2.view-the-cluster-composition/2.view-an-observer.md)

* [重启节点](1.restart-a-node.md)

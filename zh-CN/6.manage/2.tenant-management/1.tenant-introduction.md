# 租户介绍

## 租户基本概念

租户是集群之上的递进概念，OceanBase 数据库采用了多租户架构。多租户架构适用于资源整合（Resource Consolidation）、SaaS服务等场景，同时也降低了运维复杂度。

集群偏向于部署层面的物理概念，是 Zone 和节点的集合，Zone 和节点具有部署地域（称为 Region）等属性；而租户则偏向于资源层面的逻辑概念，是在物理节点上划分的资源单元，可以指定其资源规格，包括 CPU、内存、IOPS、日志盘空间等。

租户类似于传统数据库的数据库实例，租户通过资源池与资源关联，从而独占一定的资源配额，可以动态调整资源配额。在租户下可以创建 Database、表、用户等数据库对象。

要描述清楚租户的概念，首先需要描述清楚资源规格、资源池、资源单元、租户等前置概念。资源规格对应的视图是 `DBA_OB_Unit_CONFIGS`，资源池对应的视图是 `DBA_OB_RESOURCE_POOLS`，资源单元对应的视图是 `DBA_OB_UnitS`，租户对应的视图是 `DBA_OB_TENANTS`。

* Unit 是租户管理中非常重要的概念。OceanBase 按照 Unit 来管理物理资源，是 CPU、内存、存储空间、IOPS 等物理资源的集合。Unit 也是资源调度的基本单位，其具有节点、Zone、Region 等位置属性，节点是服务器的抽象，Zone 是机房的抽象，Region 是地域的抽象，通过调整 Unit 的位置属性从而调整租户的部署方式。

  通过 Unit 的概念，我们将 OceanBase 数据库的物理概念和逻辑概念进行了关联。每个租户有若干 Unit ，分布于若干 Zone 的若干节点上。而每个节点上分布有若干个 Unit ，这些 Unit 归属于不同租户。概括的讲：集群由节点组成，节点是 Unit 的容器。租户由 Unit 组成，Unit 是数据库对象的容器。

  通过调整 Unit 在同一个 Zone 内不同节点的分布（称为 副本迁移），从而达到 Zone 内不同节点间的负载均衡。节点故障时通过将其上的 Unit 迁移到同 Zone 内其他节点上，从而达到自动容灾恢复的目的。通过调整 Unit 在不同 Zone 的分布（变更租户的 Locality 属性），从而调整租户的部署模式，例如 “同城三中心”、“两地三中心”、“三地五中心” 等，从而具备不同的容灾等级。

* 每个 Unit 都归属于一个资源池，每个资源池由若干个 Unit 组成，资源池是资源分配的基本单位，同一个资源池内的各个 Unit 具有相同的资源规格，资源规格描述了该资源池内 Unit 的 CPU、内存、IOPS、日志盘空间等物理资源大小。

  ![租户介绍1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.0.0/easy-of-use/manage/tenant-management/%E7%A7%9F%E6%88%B7%E4%BB%8B%E7%BB%8D1.png)

  如上图，展示了一个由 6 个 Unit 组成的资源池 a_pool，该资源池具有如下重要属性：

  * `ZONE_LIST`：描述了该资源池中的 Unit 分布在哪些 Zone，本例为 ZONE_LIST='zone1,zone2,zone3'。
  * `Unit_NUM`：描述了 `ZONE_LIST` 中每个 Zone 中的 Unit 个数，本例为 Unit_NUM=2。
  * `Unit_CONFIG_ID`：描述了该资源池关联的资源规格，从而决定该资源池中每个 Unit 的物理资源大小，包括 CPU、内存、日志盘空间、IOPS 等。

* 创建租户时通过设置 `RESOURCE_POOL_LIST`，可以指定该租户关联到的资源池，从而该租户拥有指定资源池的 Unit。例如：设置租户 a 的 RESOURCE_POOL_LIST=('a_pool')，其部署图如下：

  ![租户介绍2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.0.0/easy-of-use/manage/tenant-management/%E7%A7%9F%E6%88%B7%E4%BB%8B%E7%BB%8D2.png)

  该租户部署于 3 个 Zone，每个 Zone 有 2 个 Unit，可以通过调整 a_pool 的 `Unit_CONFIG_ID` 参数来动态调整租户的物理资源。

## 创建租户注意事项

### 创建过程

OceanBase 仅支持创建用户租户，系统租户由集群创建时自动创建。创建用户租户是一系列操作的组合，首先创建资源规格，然后基于该资源规格创建资源池，最后创建租户并指定其资源池。所以创建租户的顺序为：资源规格->资源池->租户。

* [创建资源规格](5.commom-tenant-operations/1.create-resource-specifications.md)：创建资源规格仅仅是规格定义，不实际分配资源，可以通过 `DBA_OB_UNIT_CONFIGS` 视图查看所有资源规格。资源规格可以复用，可以建议根据业务场景抽象若干不同规格，例如小规格、中规格、大规格等，从而降低运维复杂度。但在租户资源不足需要应急扩容时，不能直接调整原规格，需要新建资源规格，或者直接更换更大一级的资源规格。
* [创建资源池](5.commom-tenant-operations/2.create-resource-pool.md)：创建资源池时会实际创建 Unit，按照规格定义分配资源，如对应节点预留资源不够将会创建失败，通过 `GV$OB_SERVERS` 视图可以查看所有节点资源分配信息。如果创建成功可以通过 `DBA_OB_RESOURCES_POOLS` 视图 和 `DBA_OB_UNITS` 视图查看资源池及其对应 Unit。资源池不能复用，成功创建租户后指定资源池将会分配给租户。
* [创建租户](5.commom-tenant-operations/3.create-tenant.md)：创建租户时通过指定 `RESOURCE_POOL_LIST` 将资源池分配给租户，可以通过 `DBA_OB_TENANTS` 视图查看所有租户。可以每个 Zone 一个资源池，使用独立的资源规格。也可以所有 Zone 使用同一个资源池，从而所有 Zone 使用同一个资源规格。除了资源池列表，还有兼容模式、Primary Zone、Locality、连接白名单等其他重要属性和系统变量，其中资源池列表为创建租户时的必填项。新建租户 Root 用户密码为空，使用前请先设置密码。

## 资源规划

创建租户前需要做好资源规划，创建租户后再调整可能会非常麻烦。做好资源规划的前提是深入理解业务场景，从而更多的参与到业务数据库架构设计中去。

资源规划有如下注意事项：

* 每个节点需要预留一定的资源，备用于租户容量不足需要紧急扩容的情况。
* 对于大量写入的业务，需要设置较大的内存和日志盘规格。对于大量消耗 CPU 资源的业务，需要错落分布于不同节点，以避免节点负载不均衡，甚至造成热点节点并影响业务。
* 集群配置项 `resource_hard_limit` 定义了 CPU 资源的超卖百分比，又被称为“超卖配置项”，OceanBase 仅支持 CPU 超卖，不支持其他资源的超卖。CPU 超卖适用于同一集群中不同租户间峰值错峰的场景，从而提高整体资源使用率。如果租户间峰值同时出现，开启 CPU 超卖可能导致租户之间 CPU 资源的互相抢占，互相影响。
* Unit 的资源规格不能超过单节点的总可分配资源，对于单 Unit 租户（资源池的 UNIT_NUM = 1）如果出现容量瓶颈，除了更换更大规格的服务器，还可以将租户水平扩展为多 Unit，从而利用多节点的资源。多 Unit 租户需要认真设计业务数据在 Unit 间的分布，以避免分布式事务对性能的损耗。如果预计业务量会突破单机容量上限，需要提前做好数据分片的设计，数据分片需要尽量避免分布式事务。
  
  从传统数据库迁移到 OceanBase 的业务，为了迁移的平滑性往往采用对等架构，即采用单 Unit 租户的设计方案，以保证业务访问数据库时依然仅需要访问单节点。当随着业务量增加达到单机容量上限后，可以扩展为多 Unit 租户，按照业务场景将业务数据拆分为多组。每组业务数据放置于一个 Unit 内，保证每个业务的数据库访问不跨机，从而在零性能损耗的情况下实现水平扩容。这也是 OceanBase 相比于传统数据库的架构优势之一：易用的水平扩展性，可以轻松突破单机容量上限。

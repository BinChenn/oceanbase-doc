# 创建资源规格

资源规格是对 CPU、内存、磁盘空间、IOPS 等资源项进行的定义。本文介绍如何创建资源规格。

## 背景信息

基于 OceanBase 3.x 版本的大量实践经验，OceanBase 4.0 的资源管理功能有很大改进：

* 支持 Unit 级别管理 CPU、内存、日志盘空间、IOPS 等资源项，不支持 Unit 级别管理数据盘空间和 Session 个数等资源项。为了兼容 3.x 版本的运维工具和测试用例，`CREATE RESOURCE UNIT` 语句依然可以指定 `MAX_DISK_SIZE` 和 `MAX_SESSION_NUM`，但是不会生效，也不会报错。
* 支持 CPU 超卖，通过超卖配置项 `resource_hard_limit` 控制。`GV$OB_SERVERS` 视图中的 `CPU_CAPACITY` 和 `CPU_CAPACITY_MAX` 字段分别表示节点 CPU 总容量和节点 CPU 总容量的超卖值，且 `CPU_CAPACITY_MAX = CPU_CAPACITY * resource_hard_limit`。
* 不再支持内存超卖，引入内存超卖可能会导致租户工作不稳定。
* 支持租户间日志盘空间隔离，系统为每个租户预留日志盘空间，避免 3.x 版本某个租户大量写入导致日志盘写爆从而影响其他租户的问题。
* 支持租户间 IOPS 隔离，引入三个 IOPS 规格参数：`MIN_IOPS`、`MAX_IOPS`、`IOPS_WEIGHT`，IOPS 规格参数默认不需要指定，系统根据 CPU 规格自动计算。如果一个节点上所有 Unit 的 `MIN_IOPS` 之和超过了磁盘 IOPS 上限，则会根据 `IOPS_WEIGHT` 权重来分配 IOPS 资源。
* Meta 租户没有独立的 Unit，系统创建租户时默认为 Meta 租户预留资源，各项资源从用户租户资源中扣除。Meta 各项资源采用默认配置，不支持用户指定。
* 创建资源规格时 CPU 规格 和内存规格是必选项，其他参数可以自动计算，其中日志盘空间按照内存规格自动计算，IOPS 规格按照 CPU 规格自动计算。

## 操作步骤

1. 使用 root 用户登录到集群的 sys 租户。

    ```sql
    $obclient -h172.30.xx.xx -P2883 -uroot@sys#cluster -p**** -A
    ```

2. 进入 OceanBase 数据库。

    ```sql
    obclient [(none)]> USE oceanbase;
    ```

3. 通过 `DBA_OB_UNIT_CONFIGS` 视图，获取已有的资源规格信息。

    ```sql
    obclient [oceanbase]> SELECT * FROM DBA_OB_UNIT_CONFIGS;
    +----------------+-------------------------------+----------------------------+----------------------------+---------+---------+-------------+---------------+----------+----------+-------------+
    | UNIT_CONFIG_ID | NAME                          | CREATE_TIME                | MODIFY_TIME                | MAX_CPU | MIN_CPU | MEMORY_SIZE | LOG_DISK_SIZE | MAX_IOPS | MIN_IOPS | IOPS_WEIGHT |
    +----------------+-------------------------------+----------------------------+----------------------------+---------+---------+-------------+---------------+----------+----------+-------------+
    |              1 | sys_unit_config               | 2022-12-20 17:50:17.035504 | 2022-12-20 17:50:17.035504 |       1 |       1 | 14495514624 |   14495514624 |    10000 |    10000 |           1 |
    |           1001 | config_mysql001_zone1_S1_okz  | 2022-12-20 18:04:31.547715 | 2022-12-20 18:04:31.547715 |     1.5 |     1.5 |  6442450944 |   19327352832 |    15000 |    15000 |           1 |
    |           1002 | config_mysql001_zone2_S1_pme  | 2022-12-20 18:04:31.561335 | 2022-12-20 18:04:31.561335 |     1.5 |     1.5 |  6442450944 |   19327352832 |    15000 |    15000 |           1 |
    |           1003 | config_mysql001_zone3_S1_jsu  | 2022-12-20 18:04:31.564510 | 2022-12-20 18:04:31.564510 |     1.5 |     1.5 |  6442450944 |   19327352832 |    15000 |    15000 |           1 |
    |           1013 | config_oracle001_zone3_S1_exu | 2022-12-26 18:28:37.969047 | 2022-12-26 18:28:37.969047 |     1.5 |     1.5 |  6442450944 |   19327352832 |    15000 |    15000 |           1 |
    |           1014 | config_oracle001_zone2_S1_hli | 2022-12-26 18:28:37.972194 | 2022-12-26 18:28:37.972194 |     1.5 |     1.5 |  6442450944 |   19327352832 |    15000 |    15000 |           1 |
    |           1015 | config_oracle001_zone1_S1_owy | 2022-12-26 18:28:37.976446 | 2022-12-26 18:28:37.976446 |     1.5 |     1.5 |  6442450944 |   19327352832 |    15000 |    15000 |           1 |
    +----------------+-------------------------------+----------------------------+----------------------------+---------+---------+-------------+---------------+----------+----------+-------------+
    7 rows in set
    ```

   `DBA_OB_UNIT_CONFIGS` 视图的详细说明，参见 [oceanbase.DBA_OB_UNIT_CONFIGS](../../../7.reference/5.system-reference/4.system-view-of-mysql-mode/2.dictionary-view-of-mysql-mode/60.oceanbase-dba_ob_unit_configs-of-mysql-mode.md)。

4. 通过 `CREATE RESOURCE UNIT` 语句，创建资源规格。

    语法如下：

    ```sql
    CREATE RESOURCE UNIT unit_name 
        MEMORY_SIZE [=] 'size_value',
        MAX_CPU [=] cpu_num,  
        [LOG_DISK_SIZE [=] 'size_value',]
        [MAX_IOPS [=] iops_num,]
        [MIN_CPU [=] cpu_num,]
        [MIN_IOPS [=] iops_num];
    ```

    参数说明：

    创建资源规格时，MAX_CPU 和 MEMORY_SIZE 必选。

    * `unit_name`：资源规格名称。
    * `MAX_CPU`：CPU 规格上限，`MIN_CPU` 是 CPU 规格下限，单位是核数。如果用户没有指定 `MIN_CPU`，默认等于 `MAX_CPU` 值。
    * `MIN_CPU`：最小的 CPU 规格，所有租户的 `MIN_CPU` 的总和不能超过该节点 CPU 总容量 `CPU_CAPACITY`。
    * `MEMORY_SIZE`：内存规格，最小为 1G。OceanBase 4.0 开始不支持内存超卖。
    * `LOG_DISK_SIZE`：日志盘空间，OceanBase 4.0 会按租户管理日志盘空间，系统为各个租户预留日志盘空间，实现按租户隔离。当用户没有指定时，`LOG_DISK_SIZE` 默认值是内存规格的 3 倍大小，最小为 2G。
    * OceanBase 4.0 支持租户间 IOPS 隔离，通过 `MAX_IOPS`、`MIN_IOPS`、`IOPS_WEIGHT` 三个参数决定。IOPS 规格参数默认不需要指定，系统根据 CPU 规格自动计算。

    `CREATE RESOURCE UNIT` 语句的详细说明，参见 [CREATE RESOURCE UNIT](../../../7.reference/4.development-guide-refactoring/1.sql-syntax/1.system-tenants/7.create-resource-unit.md)。

    示例：

    创建一个名称为 `S1_unit_config` 的资源规格，其资源配置为 CPU 为 1 核，内存 2G，日志盘空间 6G。

    ```sql
    obclient [oceanbase]> CREATE RESOURCE UNIT S1_unit_config
                    MEMORY_SIZE = '2G',
                    MAX_CPU = 1, MIN_CPU = 1,
                    LOG_DISK_SIZE = '6G',
                    MAX_IOPS = 10000, MIN_IOPS = 10000, IOPS_WEIGHT=1;
    ```

5. 查询 `DBA_OB_UNIT_CONFIGS` 视图，确认资源规格创建成功。

    ```sql
    obclient [oceanbase]> SELECT * FROM DBA_OB_UNIT_CONFIGS WHERE NAME = 'S1_unit_config';
    +----------------+----------------+----------------------------+----------------------------+---------+---------+-------------+---------------+----------+----------+-------------+
    | UNIT_CONFIG_ID | NAME           | CREATE_TIME                | MODIFY_TIME                | MAX_CPU | MIN_CPU | MEMORY_SIZE | LOG_DISK_SIZE | MAX_IOPS | MIN_IOPS | IOPS_WEIGHT |
    +----------------+----------------+----------------------------+----------------------------+---------+---------+-------------+---------------+----------+----------+-------------+
    |           1020 | S1_unit_config | 2023-01-10 22:31:38.805862 | 2023-01-10 22:31:38.805862 |       1 |       1 |  2147483648 |    6442450944 |    10000 |    10000 |           1 |
    +----------------+----------------+----------------------------+----------------------------+---------+---------+-------------+---------------+----------+----------+-------------+
    1 row in set
    ```

## 相关文档

创建资源规格后，可以在创建资源池时指定资源规格，从而使用相应大小的资源单元，并最终分配给相应的租户。详细操作参见：

* [创建资源池](2.create-resource-pool.md)

* [创建租户](3.create-tenant.md)

* [修改资源单元的配置](8.modify-resource-specifications.md)

* [删除资源单元](15.delete-resource-specification.md)

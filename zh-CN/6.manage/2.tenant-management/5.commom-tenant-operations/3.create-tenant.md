# 创建租户

本文介绍如何创建租户。

## 前提条件

创建租户需要有可用的资源池，创建资源池需要有相应的资源规格，所以创建租户的一般顺序为：创建资源规格 > 创建资源池 > 创建租户。创建租户之前，请确保有可用的资源池。有关创建资源规格和资源池的详细操作，参见 [创建资源规格](1.create-resource-specifications.md) 和 [创建资源池](2.create-resource-pool.md)。

<main id="notice" type='notice'>
 <h4>注意</h4>
 <p>OceanBase 数据库支持两种类型的租户，MySQL 兼容模式和 Oracle 兼容模式。创建租户时，您需要指定租户的类型。租户创建后，租户类型无法修改，因此创建租户前请规划好您的租户类型。</p>
</main>

## 操作步骤

1. 使用 root 用户登录到数据库的 sys 租户。

    ```sql
    $obclient -h172.30.xx.xx -P2883 -uroot@sys#cluster -p**** -A
    ```

2. 进入 oceanbase 数据库。

    ```sql
    obclient [(none)]> USE oceanbase;
    ```

3. 通过 `DBA_OB_TENANTS` 视图，查看所有的租户信息。

    ```sql
    obclient [oceanbase]> SELECT * FROM DBA_OB_TENANTS;
    +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+
    | TENANT_ID | TENANT_NAME | TENANT_TYPE | CREATE_TIME                | MODIFY_TIME                | PRIMARY_ZONE      | LOCALITY                                    | PREVIOUS_LOCALITY | COMPATIBILITY_MODE | STATUS | IN_RECYCLEBIN | LOCKED |
    +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+
    |         1 | sys         | SYS         | 2022-12-20 17:50:17.056814 | 2022-12-20 17:51:16.162367 | zone1;zone2;zone3 | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | MYSQL              | NORMAL | NO            | NO     |
    |      1001 | META$1002   | META        | 2022-12-20 18:04:31.683655 | 2023-01-06 14:40:57.872880 | zone1;zone2       | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | MYSQL              | NORMAL | NO            | NO     |
    |      1002 | mysql001    | USER        | 2022-12-20 18:04:31.689731 | 2023-01-06 14:40:57.872880 | zone1;zone2       | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | MYSQL              | NORMAL | NO            | NO     |
    |      1009 | META$1010   | META        | 2022-12-26 18:28:38.055294 | 2022-12-26 18:29:01.184333 | zone1;zone2;zone3 | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | MYSQL              | NORMAL | NO            | NO     |
    |      1010 | oracle001   | USER        | 2022-12-26 18:28:38.056350 | 2022-12-26 18:29:01.223246 | zone1;zone2;zone3 | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | ORACLE             | NORMAL | NO            | NO     |
    +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+
    5 rows in set
    ```

   `DBA_OB_TENANTS` 视图的详细说明，请参见 [oceanbase.DBA_OB_TENANTS](../../../7.reference/5.system-reference/4.system-view-of-mysql-mode/2.dictionary-view-of-mysql-mode/58.oceanbase-dba_ob_tenants-of-mysql-mode.md)

4. 通过 `CREATE TENANT` 语句，创建租户。

   * 创建一个名为 `mq_t1` 的租户（默认为 MySQL 模式租户），副本数为 3，资源池指定为 `mq_pool_01`，Primary Zone 为 zone1，允许所有 IP 连接数据库。

        ```sql
        obclient [oceanbase]> CREATE TENANT IF NOT EXISTS mq_t1 
                        REPLICA_NUM=3, 
                        PRIMARY_ZONE='zone1', 
                        RESOURCE_POOL_LIST=('mq_pool_01')
                        set OB_TCP_INVITED_NODES='%';
        ```

   * 创建一个名为 `oracle_tenant1` 的 Oracle 兼容模式租户，需要显式指定 ob_compatibility_mode='oracle';

        ```sql
        obclient [oceanbase]>CREATE TENANT IF NOT EXISTS oracle_tenant1 
                        REPLICA_NUM=3, 
                        PRIMARY_ZONE='zone1', 
                        RESOURCE_POOL_LIST=('mq_pool_01')
                        SET OB_TCP_INVITED_NODES='%',
                        ob_compatibility_mode='oracle';
        ```

   参数说明：

   * `IF NOT EXISTS`：可选参数，如果要创建的租户名已存在，并且没有指定 IF NOT EXISTS，则会出现错误。
   * `REPLICA_NUM`：指定数据的副本份数。
   * `PRIMARY_ZONE`：指定租户的 Primary Zone。

     Primary Zone 指定了租户提供读写服务的 Zone 的优先级。Primary Zone 实际上是一个 Zone 的列表，列表中包含多个 Zone。当 Primary Zone 列表包含多个 Zone 时，使用分号（;）分隔的 Zone 具有从高到底的优先级，使用逗号（,）分隔的 Zone 具有相同优先级，表示流量打散在多个 Zone 上，这几个 Zone 同时提供服务。

     例如，`primary_zone ='zone1;zone2,zone3'` 表示该租户优先由 zone1 提供读写服务，zone1 比 zone2、zone3 的优先级高，zone2 和 zone3 是同一优先级。

     <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>在指定 PRIMARY_ZONE 时，其值可以设置为 RANDOM（必须大写），表示随机选择最高优先级内的任意一个 Zone 作为 Primary Zone。</p>
     </main>

   * `RESOURCE_POOL_LIST`：指定分配给租户的资源池列表，必填。如果有多个资源池，要求多个资源池的 UNIT_NUM 个数一致。
   * `OB_TCP_INVITED_NODES`：用于指定租户连接的白名单，即允许哪些客户端 IP 连接该租户。示例中 `%` 表示所有客户端都可登录，如果不指定 OB_TCP_INVITED_NODES 的值，则默认租户的连接方式为只允许本机的 IP 登录该租户。白名单配置的详细介绍，参见 [查看和设置白名单](4.view-and-set-whitelist.md)。
   * `OB_COMPATIBILITY_MODE`：用于指定租户的兼容模式，可选择 MySQL 或 Oracle 兼容模式，并且只能在创建时指定。如果不指定 OB_COMPATIBILITY_MODE，则默认兼容模式为 MySQL 模式。

   `CREATE TENANT` 语句的详细说明，请参见 [CREATE TENANT](../../../7.reference/4.development-guide-refactoring/1.sql-syntax/1.system-tenants/8.create-tenant.md)。

5. 查询 `DBA_OB_TENANTS` 视图，确认租户创建成功。

    ```sql
    obclient [oceanbase]> SELECT * FROM DBA_OB_TENANTS WHERE TENANT_NAME = 'mq_t1';
    +-----------+-------------+-------------+----------------------------+----------------------------+--------------+------------------------------+-------------------+--------------------+--------+---------------+--------+
    | TENANT_ID | TENANT_NAME | TENANT_TYPE | CREATE_TIME                | MODIFY_TIME                | PRIMARY_ZONE | LOCALITY                     | PREVIOUS_LOCALITY | COMPATIBILITY_MODE | STATUS | IN_RECYCLEBIN | LOCKED |
    +-----------+-------------+-------------+----------------------------+----------------------------+--------------+------------------------------+-------------------+--------------------+--------+---------------+--------+
    |      1036 | mq_t1       | USER        | 2023-01-10 22:44:59.788717 | 2023-01-10 22:45:19.578586 | zone1;zone2  | FULL{1}@zone1, FULL{1}@zone2 | NULL              | MYSQL              | NORMAL | NO            | NO     |
    +-----------+-------------+-------------+----------------------------+----------------------------+--------------+------------------------------+-------------------+--------------------+--------+---------------+--------+
    1 row in set
    ```

6. 租户创建成功后，可以尝试登录租户进行使用。

   默认管理员用户（MySQL 模式为 root，Oracle 模式为 sys）的密码为空，您需要及时修改管理员用户的密码。

    * MySQL 兼容模式

      1. 登录 `mq_t1` 租户的 root 用户。

          ```sql
          $obclient -h172.30.xx.xx -P2883 -uroot@mq_t1#cluster  -A
          ```

      2. 执行以下语句修改 root 用户的密码。

          ```sql
          obclient [(none)]> ALTER USER root IDENTIFIED BY '****';
          Query OK, 0 rows affected
          ```

    * Oracle 兼容模式

      1. 登录 `moracle_tenant1` 租户的 sys 用户。

          ```sql
          $obclient -h172.30.xx.xx -P2883 -usys@oracle_tenant1#cluster  -A
          ```

      2. 执行以下语句修改 sys 用户的密码。

          ```sql
          obclient [SYS]> ALTER USER sys IDENTIFIED BY '****';
          Query OK, 0 rows affected
          ```

7. 管理员用户密码修改成功后，重新登录租户。

    * MySQL 兼容模式

        ```sql
        $obclient -h172.30.xx.xx -P2883 -uroot@mq_t1#cluster -p**** -A
        ```

    * Oracle 兼容模式

        ```sql
        $obclient -h172.30.xx.xx -P2883 -usys@oracle_tenant1#cluster -p**** -A
        ```

## 更多信息

租户创建后，您可以对租户配置进行查看和维护。详细操作，请参见：

* [查看租户和资源信息](4.view-tenant-information.md)

* [修改租户属性](10.modify-tenant-properties.md)

* [删除租户](11.tenant-locking-and-unlocking.md)

* [恢复租户](12.delete-tenant.md)

您也可以尝试登录租户进行数据库使用。详细操作，请参见：

* [查看和设置租户白名单](4.view-and-set-whitelist.md)

* [登录租户](5.log-in-a-tenant.md)

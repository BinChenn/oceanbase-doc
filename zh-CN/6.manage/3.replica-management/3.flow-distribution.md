# 流量分布

本文介绍什么是流量分布。

流量分布通过 Primary Zone 来描述，描述了 Leader 副本的偏好位置，即 Primary Zone 决定了 OceanBase 数据库的流量分布。

## Primary Zone 介绍

Primary Zone 实际上是一个 Zone 的列表，列表中包含多个 Zone。该列表用如下方式为 Zone 配置优先级：

当 Primary Zone 列表包含多个 Zone 时，用 ';' 分隔的具有从高到底的优先级；用 ',' 分隔的具有相同优先级，表示流量打散在多个 Zone 上，这几个Zone同时提供服务。

例如：`'hz1,hz2;sh1,sh2;sz1'` 表示 `hz1` 和 `hz2` 具有相同的优先级，并且优先级高于 `sh1/sh2` 和 `sz1`；`sh1` 和 `sh2` 具有相同优先级，并且优先级高于 `sz1`。

OceanBase4.0 仅支持租户级别的 Primary Zone，不再支持表级、DB级、Tablegroup 级配置 Primary Zone 。如果创建租户时未指定 primary_zone，默认填写为 RANDOM，表示各个 Zone 优先级相同。

## Region 属性

在 OceanBase 数据库中，Zone 有一个 Region 属性（ DBA_OB_ZONES 的 REGION 字段），表示该 Zone 所处的地区，每个 Zone 仅能配置一个 Region，但一个 Region 内可包含多个 Zone。Primary Zone 的设置隐含的包含了 Leader 偏好的 Region 位置。具体指用户设置 Primary Zone 时包含两层语义：

* 被指定的 Primary Zone 为 Leader 的偏好 Zone 的 Region。

* 被指定 Primary Zone 所在的 Region 为 Leader 偏好的 Region。
  
具体地，Leader 会被优先调度到最高优先级的 Zone 上去，如果最高优先级的 Zone 上的副本不能成为 Leader，会优先选择同一个 Region 内的其他 Zone 作为 Leader 的位置，从而保证业务访问 OceanBase 数据库尽量不跨城。

## Primary Zone 改写

用户设置的 Primary Zone 会由 OceanBase 数据库基于各个 Zone 所在的 Region 进行改写，改写规则如下：

1. 将用户设置的 Primary Zone 中的所有 Zone 对应的 Region 列出。例如：primary_zone 为 `hz1,hz2;sh1,sh2;sz1` 对应的 primary_region 的列表为 `hz,hz;sh,sh;sz` 。

2. 将 primary_region 中重复的 Region 去掉，去掉规则为保留第一个出现的 Region，其他 Region 后续重复的 Region 移除，例如 `hz1,hz2;sh1,sh2;sz1` ，其 primary_region 转化为列表 `hz;sh;sz` 。
  
3. 依据 primary_region 中各 Region 的优先级，对 primary_zone 进行补充，补充规则如下：将 Primary Zone 中各 Region 对应的 Zone 都取出，重新排列，高优先级 Region 内 Zone 比低优先级 Region 内 Zone 的优先级高，同一 Region 内 Zone 的优先级高低参考原始 Primary Zone 中的优先级。

例如：

假设共有 9 个 Zone，`sh1`、`sh2`、`sh3` 三个 Zone 在 Region `SH`，`hz1`、`hz2`、`hz3` 三个 Zone 在 Region `HZ`，`sz1`、`sz2`、`sz3` 三个 Zone 在 Region `SZ`。

* 用户设置的 primary_zone 为 `'sh1;hz1;hz2;sz1'`; 按照改写规则 1 得到 primary_region 为 `'SH;HZ;HZ;SZ'`。按照改写规则 2 得到 primary_zone 为 `'SH;HZ;SZ'`。按规则 3 得到改写后 primary_zone 为 `'sh1;sh2,sh3;hz1;hz2;hz3;sz1;sz2,sz3'`。
  
  解释如下：

    三个 Region 的优先级为 `SH` > `HZ` > `SZ`。Region `SH` 中的 Zone 的优先级高于 Region `HZ` 和 Region `SZ` 中 Zone 的优先级。Region `HZ` 中的 Zone 的优先级高于 Region `SZ` 中 Zone 的优先级。各 Region 内每个 Zone 的优先级为：在 Region `SH` 中 `sh1` > `sh2` = `sh3`，在 Region `HZ` 中 `hz1` > `hz2` > `hz3`，在 Region `SZ` 中 `sz1` > `sz2` = `sz3`。因此最终得到新的 Primary Zone 为 `'sh1;sh2,sh3;hz1;hz2;hz3;sz1;sz2,sz3'`。Leader 会优先分布在 `sh1` 上，当 `sh1` 发生故障时，Leader 会依照上面的 Primary Zone 优先级依次分布在 `sh2` 和 `sh3`。

* 用户设置的 primary_zone 为 `'sh1,sh2;hz1;hz2;sz1'`; 按照改写规则 1 得到 primary_region 为 `'SH,SH;HZ;HZ;SZ'`。按照改写规则 2 得到 primary_zone 为 `'SH;HZ;SZ'`。按规则 3 得到改写后 primary_zone 为 `'sh1,sh2;sh3;hz1;hz2;hz3;sz1;sz2,sz3'`。
  
  解释如下：

    三个 Region 的优先级为 `SH` > `HZ` > `SZ`。Region `SH` 中的 Zone 的优先级高于 Region `HZ` 和 Region `SZ` 中 Zone 的优先级。Region `HZ` 中的 Zone 的优先级高于 Region `SZ` 中 Zone 的优先级。各 Region 内每个 Zone的优先级为：在 Region `SH` 中 `sh1` = `sh2` > `sh3`，在 Region `HZ` 中 `hz1` > `hz2` > `hz3`，在 Region `SZ` 中 `sz1` > `sz2` = `sz3`。因此最终得到新的 Primary Zone 为 `'sh1,sh2;sh3;hz1;hz2;hz3;sz1;sz2,sz3'`。Leader 会优先平均分布在 `sh1` 和 `sh2` 上，当 `sh1` 和 `sh2` 发生故障时，Leader 会依照上面 Primary Zone 优先级依次分布在 `sh3`。

* 用户设置的 primary_zone 为 `'sh1,hz1;hz2;sz1'`; 按照改写规则 1 得到 primary_region 为 `'SH,HZ;HZ;SZ'`。按照改写规则 2 得到 primary_zone 为 `'SH,HZ;SZ'`。按规则 3 得到改写后 primary_zone 为 `'sh1,hz1;hz2;sh2,sh3,hz3;sz1;sz2,sz3'`。
  
  解释如下：

    三个 Region 的优先级为 `SH` = `HZ` > `SZ`。Region `SH` 和 Region `HZ` 中的 Zone 的优先级高于 Region `SZ` 中 Zone 的优先级。`sh1` = `hz1` > `hz2` > `sh2` = `sh3` = `hz3` > `sz1` > `sz2` = `sz3`。因此最终得到新的 Primary Zone 为 `'sh1,hz1;hz2;sh2,sh3,hz3;sz1;sz2,sz3'`。Leader 会优先平均分布在 `sh1` 和 `hz1` 上，当 `sh1` 和 `hz1` 发生故障时，Leader 会依照上面 Primary Zone 优先级依次分布在 `hz2`。

# Log Stream（日志流）

日志流（Log Stream）是指在计算机系统中，将日志数据以流的形式进行传输和处理的技术。

日志流的主要作用是将分布式系统中的日志数据实时地收集、传输、存储和分析，以更好地了解系统的运行情况和排查问题。

日志流是由 OceanBase 数据库自动创建和管理的实体，它代表了一批数据的集合，包括若干 Tablet 和有序的 RedoLog 日志流。

RedoLog 是基于 Paxos 协议实现的日志模块，TxCrMgr 是事务管理结构。日志流通过 Paxos 协议实现了多副本日志同步，保证副本间数据的一致性，实现了数据的高可用。日志流副本支持在不同机器之间迁移和复制，以达到机器管理和系统容灾的目的。

日志流由系统自动创建，集群内需要执行事务的每个节点都有一个对应的日志流。日志流通过选举协议确定多个副本中的一个为 Leader，通过 Paxos 协议保证 Leader 产生的日志在其他副本上的一致性。每个节点上允许有多个日志流（有 Leader 也有 Follower），日志流各自记录自己的 Tablet 列表。

从数据存储角度看，日志流可以抽象为 Tablet 容器，支持添加和管理 Tablet 数据，允许 Tablet 在不同日志流之间转移，以达到数据均衡和水平扩展的目的。

从事务角度看，日志流是事务的提交单位。事务修改在单个日志流内完成时可以采用一阶段原子提交；事务修改跨多个日志流时，采用 OceanBase 优化的两阶段提交协议完成原子提交，日志流是分布式事务的参与者。

![日志流](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.0.0/easy-of-use/manage/replica-management/replica-fine-granularity/log-stream.png)

## 查看日志流相关信息

* 通过视图 `oceanbase.DBA_OB_LS` 查看本租户所有日志流的基本信息，包括状态、日志进度等。

    有关 `oceanbase.DBA_OB_LS` 视图的详细信息，参见 [oceanbase.DBA_OB_LS](../../../7.reference/5.system-reference/4.system-view-of-mysql-mode/2.dictionary-view-of-mysql-mode/176.oceanbase-dba_ob_ls-of-mysql-mode.md)

    示例如下：

    ```sql
    obclient> SELECT * FROM oceanbase.DBA_OB_LS limit 10;
    +-------+--------+----------------------------------------+---------------+-------------+------------+----------+----------+--------------+
    | LS_ID | STATUS | PRIMARY_ZONE                           | UNIT_GROUP_ID | LS_GROUP_ID | CREATE_SCN | DROP_SCN | SYNC_SCN | READABLE_SCN |
    +-------+--------+----------------------------------------+---------------+-------------+------------+----------+----------+--------------+
    |     1 | NORMAL | sa128_obv4_2;sa128_obv4_1,sa128_obv4_3 |             0 |           0 |       NULL |     NULL |     NULL |         NULL |
    +-------+--------+----------------------------------------+---------------+-------------+------------+----------+----------+--------------+
    1 row in set 
    ```

    <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>以上语句可在系统租户和用户租户执行，以查看本租户对应的日志流。<br>例如上例在系统租户执行，所示为系统租户仅有的一个 1 号日志流。</p>
    </main>

* 通过系统租户的 `oceanbase.CDB_OB_LS` 视图可以查看所有租户的日志流信息。

    有关 `oceanbase.CDB_OB_LS` 视图的详细信息，参见 [oceanbase.CDB_OB_LS](../../../7.reference/5.system-reference/4.system-view-of-mysql-mode/2.dictionary-view-of-mysql-mode/175.oceanbase-cdb_ob_ls-of-mysql-mode.md)

    示例如下：

    以查询租户 mq_t1 的日志流信息为例。

    ```sql

    --查询租户 mq_t1 的基本信息。

    obclient> SELECT * FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_ID=1004;
    +-----------+-------------+-------------+----------------------------+----------------------------+----------------------------------------+------------------------------------------------------------------+-------------------+--------------------+--------+---------------+--------+
    | TENANT_ID | TENANT_NAME | TENANT_TYPE | CREATE_TIME                | MODIFY_TIME                | PRIMARY_ZONE                           | LOCALITY                                                         | PREVIOUS_LOCALITY | COMPATIBILITY_MODE | STATUS | IN_RECYCLEBIN | LOCKED |
    +-----------+-------------+-------------+----------------------------+----------------------------+----------------------------------------+------------------------------------------------------------------+-------------------+--------------------+--------+---------------+--------+
    |      1004 | mq_t1       | USER        | 2023-01-04 18:32:08.212745 | 2023-01-04 18:32:33.343667 | sa128_obv4_1;sa128_obv4_2,sa128_obv4_3 | FULL{1}@sa128_obv4_1, FULL{1}@sa128_obv4_2, FULL{1}@sa128_obv4_3 | NULL              | MYSQL              | NORMAL | NO            | NO     |
    +-----------+-------------+-------------+----------------------------+----------------------------+----------------------------------------+------------------------------------------------------------------+-------------------+--------------------+--------+---------------+--------+
    2 rows in set 

    --查询租户 mq_t1 的 unit 信息。

    obclient> SELECT * FROM oceanbase.DBA_OB_UNITS WHERE TENANT_ID=1004;
    +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+--------------+------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+----------+----------+-------------+
    | UNIT_ID | TENANT_ID | STATUS | RESOURCE_POOL_ID | UNIT_GROUP_ID | CREATE_TIME                | MODIFY_TIME                | ZONE         | SVR_IP     | SVR_PORT | MIGRATE_FROM_SVR_IP | MIGRATE_FROM_SVR_PORT | MANUAL_MIGRATE | UNIT_CONFIG_ID | MAX_CPU | MIN_CPU | MEMORY_SIZE | LOG_DISK_SIZE | MAX_IOPS | MIN_IOPS | IOPS_WEIGHT |
    +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+--------------+------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+----------+----------+-------------+
    |    1004 |      1004 | ACTIVE |             1005 |          1003 | 2023-01-04 11:48:36.582413 | 2023-01-04 18:32:08.215935 | sa128_obv4_1 | 6.3.27.47  |     2882 | NULL                |                  NULL | NULL           |           1006 |       3 |       3 | 12884901888 |   38654705664 |    30000 |    30000 |           3 |
    |    1005 |      1004 | ACTIVE |             1005 |          1003 | 2023-01-04 11:48:36.591414 | 2023-01-04 18:32:08.215935 | sa128_obv4_2 | 6.0.132.81 |     2882 | NULL                |                  NULL | NULL           |           1006 |       3 |       3 | 12884901888 |   38654705664 |    30000 |    30000 |           3 |
    |    1006 |      1004 | ACTIVE |             1005 |          1003 | 2023-01-04 14:13:36.980799 | 2023-01-04 18:32:08.217005 | sa128_obv4_3 | 6.0.187.19 |     2882 | NULL                |                  NULL | NULL           |           1006 |       3 |       3 | 12884901888 |   38654705664 |    30000 |    30000 |           3 |
    +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+--------------+------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+----------+----------+-------------+
    3 rows in set 

    --查询租户 mq_t1 所对应的日志流信息

    obclient> SELECT * FROM oceanbase.CDB_OB_LS WHERE TENANT_ID=1004;
    +-----------+-------+--------+----------------------------------------+---------------+-------------+---------------------+----------+---------------------+---------------------+
    | TENANT_ID | LS_ID | STATUS | PRIMARY_ZONE                           | UNIT_GROUP_ID | LS_GROUP_ID | CREATE_SCN          | DROP_SCN | SYNC_SCN            | READABLE_SCN        |
    +-----------+-------+--------+----------------------------------------+---------------+-------------+---------------------+----------+---------------------+---------------------+
    |      1004 |     1 | NORMAL | sa128_obv4_1;sa128_obv4_2,sa128_obv4_3 |             0 |           0 |                NULL |     NULL | 1672828583776007012 | 1672828583428825226 |
    |      1004 |  1001 | NORMAL | sa128_obv4_1;sa128_obv4_2,sa128_obv4_3 |          1003 |        1001 | 1672828353411747395 |     NULL | 1672828589869877321 | 1672828589668619710 |
    +-----------+-------+--------+----------------------------------------+---------------+-------------+---------------------+----------+---------------------+---------------------+
    2 rows in set 
    ```

    根据查询结果，1004 租户为 mq_t1，其 `PRIMARY_ZONE = 'sa128_obv4_1 ;sa128_obv4_2,sa128_obv4_3'` ，`unit_num = 1`。所以共有 1 条用户表数据的日志流，其 `LS_ID =  1001` 。另一条 `LS_ID = 1` 的日志流负责了用户租户下的系统表数据。

* `oceanbase.DBA_OB_TABLET_TO_LS` 视图维护了 Tablet 到日志流的映射关系，从而获取 Tablet 位置信息。

    有关 `oceanbase.DBA_OB_TABLET_TO_LS` 视图的详细信息，参见 [oceanbase.DBA_OB_TABLET_TO_LS](../../../7.reference/5.system-reference/4.system-view-of-mysql-mode/2.dictionary-view-of-mysql-mode/56.oceanbase-dba_ob_tablet_to_ls-of-mysql-mode.md)

    示例如下：

    ```sql
    obclient> SELECT * FROM oceanbase.DBA_OB_TABLET_TO_LS limit 10;
    +-----------+-------+
    | TABLET_ID | LS_ID |
    +-----------+-------+
    |         1 |     1 |
    |    100001 |     1 |
    |    100002 |     1 |
    |    100003 |     1 |
    |     50003 |     1 |
    |     60003 |     1 |
    |         3 |     1 |
    |    100004 |     1 |
    |    100005 |     1 |
    |     50004 |     1 |
    +-----------+-------+
    10 rows in set 
    ```

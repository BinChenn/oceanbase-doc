# 数据库层高可用

OceanBase 数据库基于高性价比的普通服务器采用 Paxos 协议，同一份数据写到多台（>= 3）节点的半数以上，因此当少数派节点发生故障时不会有任何数据丢失，保证 RPO=0；Leader 副本发生故障后，剩余的 Follower 副本能够在短时间内自动选出新 Leader 继续提供服务，无需外部介入，保证 RTO < 30 秒，从而达到强一致和高可用的平衡。用户也可以采用灵活的部署模式，例如，同城三中心、两地三中心、三地五中心等，从而达到各级无损容灾能力，例如同城容灾和异地容灾。

## RootService

在 OceanBase 数据库中，RootService 负责集群的节点管理，各 OBServer 通过心跳数据包（heartbeat）的方式，定期（每 2s）向 RootService 汇报自己的进程状态，RootService 通过监测 OBServer 的心跳数据包，来获取当前 OBServer 进程的工作状态。

OBServer 心跳状态相关的配置项如下：

* `lease_time`
  
  集群级配置项 `lease_time` 用于设置心跳租约时长。该配置项的默认值为 10s。有关该配置项的详细信息，请参见 [lease_time](../../../7.reference/5.system-reference/1.system-configuration-items/3.cluster-level-configuration-items/118.lease_time.md)。

  当 RootService 累计超过 `lease_time` 时间没有收到过某 OBServer 的任意心跳数据包时，RootService 认为该 observer 进程短暂断线，RootService 会标记该 OBServer 的心跳状态为 `lease_expired`。

* `server_permanent_offline_time`
  
  集群级配置项 `server_permanent_offline_time` 用于设置节点心跳中断的时间阈值，即节点心跳中断多久后认为其被永久下线，永久下线的节点上的数据副本需要被自动补足。该配置项的默认值为 3600s。有关该配置项的更多详细信息，请参见 [server_permanent_offline_time](../../../7.reference/5.system-reference/1.system-configuration-items/3.cluster-level-configuration-items-1/190.server_permanent_offline_time-1-2-3.md)。

  当 RootService 累计超过 `server_permanent_offline_time` 时间没有收到过某 OBServer 的任意心跳数据包时，RootService 认为该 observer 进程断线，RootService 会标记该 OBServer 的心跳状态为 `permanent_offline`。

<main id="notice" type='explain'>
            <h4>说明</h4>
            <p>您可以通过 <code>SHOW PARAMETERS</code> 语句查看以上集群级配置项的值，例如，<code>SHOW PARAMETERS LIKE 'server_permanent_offline_time';</code>。</p>
          </main>

RootService 根据心跳数据包可以获得 OBServer 如下的工作状态：

* OBServer 心跳数据包存在，心跳数据包中的 OBServer 磁盘状态正常。此种状态下，RootService 认为 OBServer 处于正常工作状态。

* OBServer 心跳数据包存在，心跳数据包中的 OBServer 磁盘状态异常。此种状态下，RootService 认为 observer 的进程还在，但 OBServer 磁盘故障。此种状态下，RootService 会尝试将该 OBServer 上的全部 leader 副本切走。

* OBServer 心跳数据包不存在，OBServer 心跳数据包的丢失时间还比较短，OBServer 心跳状态为 lease_time，此种状态下，RootService 仅将 OBServer 的工作状态设置为 inactive，不做其他处理。

* OBServer 心跳数据包不存在，OBServer 心跳数据包丢失时间超过 `server_permanent_offline_time`，OBServer 的心跳状态为 `permanent_offline`，此种情况下，RootService 会对该 OBServer 上的数据副本进行处理，将该 OBServer 上包含的数据副本从 Paxos 成员组中删除，并在其他可用 OBServer 上补充数据，以保证数据副本 Paxos 成员组完整。

## 隔离节点

OBProxy 会感知 OBServer 的异常状态，例如 stopped（`ACTIVE` 状态且 `stop_time` 字段大于 0）状态、`INACTIVE` 状态等，从而避免将应用流量路由到异常节点上。

如果某个节点不稳定，可能时不时提供服务，存在响应慢等各种不正常情况。如果客户端连接到该节点，将导致客户端感受到不稳定。OceanBase 数据库提供了 `STOP SERVER` 命令用于隔离节点。隔离后，该节点不会对外提供服务，OBProxy 也不会把请求路由到该节点上，可以安全的进行诊断/替换/维修等动作，是运维和应急的利器。Stop Server 会检查所有剩余副本是否满足多数派、是否日志同步，当条件不满足的时候 Stop Server 操作会返回失败；条件满足的情况下等待故障节点上的 Leader 全部切走后系统会返回成功。Stop Server 成功后保证能够做任何运维动作，包括 Kill observer 进程。Stop Server 的详细操作请参见 [隔离节点](暂时无法加链接)。

节点隔离适用于单机房故障场景：

* 非通断型故障（例如网卡丢包导致的机器不稳定）强依赖节点隔离，否则会发生反复切主而影响应用。

* 通断型故障（例如机器直接宕机）不强依赖节点隔离，其会在 `oceanbase.DBA_OB_ZONES` 视图标记节点状态为 `INACTIVE` 而隔离应用流量。

在节点隔离或者 Leader 出现故障时，会触发选举。选举服务的优先级机制会考虑用户指定的 Primary Zone，考虑机器的异常状态等，从而保证选择更优的副本作为主副本。

## 主动切主

除了隔离节点，您还可以主动切主，切换日志流副本的主备角色。

主动切主的操作步骤如下：

1. 使用 `root` 用户登录到数据库的 `sys` 租户。

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   obclient -h10.xx.xx.xx -P2883 -uroot@sys -p***** -A
   ```

   有关更加详细的连接数据库的操作指引，请参见 [连接数据库](../../../3.develop/1.application-development-based-on-mysql-mode/1.database-connection-of-mysql/1.connection-mode-overview.md)。

2. 获取租户的 Zone、Server 及日志流副本信息。

   * 查询 `oceanbase.DBA_OB_ZONES` 视图获取 Zone 信息

     ```sql
     obclient [test]> SELECT * FROM oceanbase.DBA_OB_ZONES;
     +--------------+----------------------------+----------------------------+--------+-------+----------+-----------+
     | ZONE         | CREATE_TIME                | MODIFY_TIME                | STATUS | IDC   | REGION   | TYPE      |
     +--------------+----------------------------+----------------------------+--------+-------+----------+-----------+
     | sa128_obv4_1 | 2022-11-03 15:37:17.462047 | 2022-12-12 12:26:20.825741 | ACTIVE | sa128 | HEYUAN   | ReadWrite |
     | sa128_obv4_2 | 2022-11-03 15:37:17.463136 | 2022-12-12 11:47:30.305683 | ACTIVE | sa128 | HEYUAN   | ReadWrite |
     | sa128_obv4_3 | 2022-11-03 15:37:17.464204 | 2022-12-12 12:43:12.944136 | ACTIVE | sa128 | HEYUAN   | ReadWrite |
     | zone4        | 2022-11-18 15:22:08.286765 | 2022-12-12 12:44:55.210223 | ACTIVE | HZ1   | HANGZHOU | ReadWrite |
     +--------------+----------------------------+----------------------------+--------+-------+----------+-----------+
     4 rows in set
     ```
     有关 `oceanbase.DBA_OB_ZONES` 视图的更多详细信息，请参见 [oceanbase.DBA_OB_ZONES](../../../7.reference/5.system-reference/4.system-view-for-mysql/2.dictionary-view-5/63.oceanbase-dba_ob_zones.md)。

   * 查询 `oceanbase.DBA_OB_SERVERS` 视图获取 OBServer 信息

     ```sql
     obclient [test]> SELECT * FROM oceanbase.DBA_OB_SERVERS;
     +-------------+----------+----+--------------+----------+-----------------+--------+----------------------------+-----------+-----------------------+----------------------------+----------------------------+-------------------------------------------------------------------------------------------+
     | SVR_IP      | SVR_PORT | ID | ZONE         | SQL_PORT | WITH_ROOTSERVER | STATUS | START_SERVICE_TIME         | STOP_TIME | BLOCK_MIGRATE_IN_TIME | CREATE_TIME                | MODIFY_TIME                | BUILD_VERSION                                                                             |
     +-------------+----------+----+--------------+----------+-----------------+--------+----------------------------+-----------+-----------------------+----------------------------+----------------------------+-------------------------------------------------------------------------------------------+
     | xx.xx.xx.158 |     2882 |  3 | sa128_obv4_3 |     2881 | NO              | ACTIVE | 2022-11-14 12:28:49.796499 | NULL      | NULL                  | 2022-11-03 15:37:09.530894 | 2022-11-14 12:28:50.795464 | 4.0.0.0_100000302022111120-7cef93737c5cd03331b5f29130c6e80ac950d33b(Nov 11 2022 20:38:33) |
     | xx.xx.xx.43   |     2882 |  1 | sa128_obv4_1 |     2881 | NO              | ACTIVE | 2022-11-14 11:57:31.763941 | NULL      | NULL                  | 2022-11-03 15:37:08.990683 | 2022-11-14 11:57:32.762787 | 4.0.0.0_100000302022111120-7cef93737c5cd03331b5f29130c6e80ac950d33b(Nov 11 2022 20:38:33) |
     | xx.xx.xx.106  |     2882 |  2 | sa128_obv4_2 |     2881 | YES             | ACTIVE | 2022-11-14 11:35:34.223948 | NULL      | NULL                  | 2022-11-03 15:37:09.490511 | 2022-11-14 11:37:26.542479 | 4.0.0.0_100000302022111120-7cef93737c5cd03331b5f29130c6e80ac950d33b(Nov 11 2022 20:38:33) |
     +-------------+----------+----+--------------+----------+-----------------+--------+----------------------------+-----------+-----------------------+----------------------------+----------------------------+-------------------------------------------------------------------------------------------+
     3 rows in set
     ```

     有关 `oceanbase.DBA_OB_SERVERS` 视图的更多详细信息，请参见 [oceanbase.DBA_OB_SERVERS](../../../7.reference/5.system-reference/4.system-view-for-mysql/2.dictionary-view-5/50.oceanbase-dba_ob_servers.md)。

   * 获取日志流信息

     ```sql
     obcllient [(none)]> SELECT a.TENANT_ID,a.LS_ID,b.TENANT_NAME,b.TENANT_TYPE,b.PRIMARY_ZONE FROM oceanbase.CDB_OB_LS a, oceanbase.DBA_OB_TENANTS b WHERE a.TENANT_ID=b.TENANT_ID;
     +-----------+-------+-------------+-------------+-------------------+
     | TENANT_ID | LS_ID | TENANT_NAME | TENANT_TYPE | PRIMARY_ZONE      |
     +-----------+-------+-------------+-------------+-------------------+
     |         1 |     1 | sys         | SYS         | zone1;zone2;zone3 |
     |      1001 |     1 | META$1002   | META        | zone1;zone2       |
     |      1002 |     1 | mysql001    | USER        | zone1;zone2       |
     |      1002 |  1001 | mysql001    | USER        | zone1;zone2       |
     |      1009 |     1 | META$1010   | META        | zone1;zone2;zone3 |
     |      1010 |     1 | oracle001   | USER        | zone1;zone2;zone3 |
     |      1010 |  1001 | oracle001   | USER        | zone1;zone2;zone3 |
     +-----------+-------+-------------+-------------+-------------------+
     7 rows in set
     ```

   有关 `CDB_OB_LS` 视图的更多信息，请参见 [CDB_OB_LS](../../../7.reference/5.system-reference/4.system-view-of-mysql-mode/2.dictionary-view-of-mysql-mode/175.oceanbase-cdb_ob_ls-of-mysql-mode.md)。

3. 根据实际场景，选择合适的命令切主。

   语法如下：

   * 设置某一个日志流副本的角色，必须指定 LS_id、SERVER 和 TENANT

      ```sql
      ALTER SYSTEM SWITCH REPLICA role LS = ls_id SERVER = 'IP:PORT' TENANT = tenant;
      ```

   * 设置某一台 OBServer 上所有副本的角色，支持指定租户名

      ```sql
      ALTER SYSTEM SWITCH REPLICA role SERVER = 'IP:PORT' [TENANT = tenant];
      ```

   * 设置某一个 Zone 中所有副本的角色，支持指定租户名

      ```sql
      ALTER SYSTEM SWITCH REPLICA role ZONE = zone [TENANT = tenant];
      ```

      其中， role 包括：LEADER、FOLLOWER。

主动切主适用于机房容灾和城市容灾场景，您可以将 Leader 切换到指定的 Zone 或者 Region，从而更加契合应用流量的分布。

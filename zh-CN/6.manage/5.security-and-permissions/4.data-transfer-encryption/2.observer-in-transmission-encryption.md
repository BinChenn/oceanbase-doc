# OBServer 传输加密

可以通过以下方法设置 OBServer 的传输加密。

## 创建 CA 证书

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

1. 创建目录存放证书文件。

    <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>证书文件的 Common Name( CN ) 不能相同。</p>
    </main>

    ```shell
    mkdir ~/tls
    chmod 700 ~/tls
    cd ~/tls
    ```

2. 创建 RSA 私钥。

   ```shell
   $ openssl genrsa 2048 > cakey.pem
   Generating RSA private key, 2048 bit long modulus
   ....................................................................+++
   ..............+++
   e is 65537 (0x10001)
   ```

3. 生成 CA 证书。

   ```shell
   $ openssl req -new -x509 -nodes -days 3600 -key cakey.pem -out ca.pem
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [XX]:CN
   State or Province Name (full name) []:ZJ
   Locality Name (eg, city) [Default City]:HZ
   Organization Name (eg, company) [Default Company Ltd]:OceanBase
   Organizational Unit Name (eg, section) []:PD
   Common Name (eg, your name or your server's hostname) []:ob
   Email Address []:
   ```

## 生成服务器证书

登录可以执行 OpenSSL 命令的 OBServer 服务器端机器，进行以下操作。

1. 生成服务器私钥。

   ```shell
   $ openssl req -newkey rsa:2048 -days 3600 -nodes -keyout server-key.pem -out server-req.pem
   Generating a 2048 bit RSA private key
   ............................+++
   ................................+++
   writing new private key to 'server-key.pem'
   -----
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [XX]:CN
   State or Province Name (full name) []:ZJ
   Locality Name (eg, city) [Default City]:HZ
   Organization Name (eg, company) [Default Company Ltd]:OceanBase
   Organizational Unit Name (eg, section) []:PD
   Common Name (eg, your name or your server's hostname) []:observer
   Email Address []:
   Please enter the following 'extra' attributes
   to be sent with your certificate request
   A challenge password []:OceanBase123
   An optional company name []:
   ```

2. 生成服务器证书。

   ```shell
   openssl x509 -req -in server-req.pem -days 3600 -CA ca.pem -CAkey cakey.pem -set_serial 01 -out server-cert.pem
   ```

## 生成客户端证书

登录可以执行 OpenSSL 命令的客户端机器，进行以下操作。

1. 生成客户端私钥。

   ```shell
   $ openssl req -newkey rsa:2048 -days 3600 -nodes -keyout client-key.pem -out client-req.pem
   Generating a 2048 bit RSA private key
   ........................................+++
   ...........................................+++
   writing new private key to 'client-key.pem'
   -----
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [XX]:CN
   State or Province Name (full name) []:ZJ
   Locality Name (eg, city) [Default City]:HZ
   Organization Name (eg, company) [Default Company Ltd]:OceanBase
   Organizational Unit Name (eg, section) []:PD
   Common Name (eg, your name or your server's hostname) []:obclient
   Email Address []:
   Please enter the following 'extra' attributes
   to be sent with your certificate request
   A challenge password []:OceanBase123
   An optional company name []:
   ```

2. 生成客户端证书。

   ```shell
   $ openssl x509 -req -in client-req.pem -days 3600 -CA ca.pem -CAkey cakey.pem -set_serial 01 -out client-cert.pem
   Signature ok
   subject=/C=CN/ST=ZJ/L=HZ/O=OceanBase/OU=PD/CN=obclient
   Getting CA Private Key
   ```

## 验证证书文件

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

```shell
$ openssl verify -CAfile ca.pem server-cert.pem client-cert.pem
server-cert.pem: OK
client-cert.pem: OK
```

## 在服务端开启 SSL

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

1. 在服务端的 OceanBase 数据库的安装目录下创建子目录 `wallet/`，默认在 `/home/admin/oceanbase/wallet/`。

   ```shell
   mkdir /home/admin/oceanbase/wallet/
   ```

2. 复制服务端相关的 3 个文件 `ca.pem`、`server-key.pem` 和 `server-cert.pem` 至 安装目录 `wallet/` 下。

   ```shell
   $ cp ca.pem server-key.pem server-cert.pem /home/admin/oceanbase/wallet/
   $ chmod 700 /home/admin/oceanbase/wallet/*.pem
   $ ls -l /home/admin/oceanbase/wallet/
   total 12
   -rwx------ 1 admin admin 1269 Oct 27 20:05 ca.pem
   -rwx------ 1 admin admin 1151 Oct 27 20:05 server-cert.pem
   -rwx------ 1 admin admin 1675 Oct 27 20:05 server-key.pem
   ```

### 以bkmi形式配置SSL通信依赖的秘钥证书

1. 使用root用户登录数据库的sys租户
2. 账户配置 `ssl_external_kms_info`
  
  ```shell
  alter system set ssl_external_kms_info = '
  {
  "ssl_mode":"bkmi",
  "kms_host":"http://bkmi.test.alipay.net/bkmi/api", 
  "root_cert": 
  "-----BEGIN CERTIFICATE-----
  MIIDqTCCApGgAwIBAgIHBXbH+VUEQTANBgkqhkiG9w0BAQsFADBaMSwwKgYDVQQD
  DCNBbnQgRmluYW5hY2lhbCBJbnRyYW5ldCBDQSBSb290IFJTQTEXMBUGA1UECgwO
  QW50IEZpbmFuYWNpYWwxETAPBgNVBAsMCEludHJhbmV0MB4XDTE4MDkyNjE1MzUz
  N1oXDTQ4MDkyNjE1MzUzN1owWjEsMCoGA1UEAwwjQW50IEZpbmFuYWNpYWwgSW50
  cmFuZXQgQ0EgUm9vdCBSU0ExFzAVBgNVBAoMDkFudCBGaW5hbmFjaWFsMREwDwYD
  VQQLDAhJbnRyYW5ldDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJlz
  hgCvUVB7wE4/V4Oj9Gq0Qji5dlIF2AyQ/L6xG/aM2cXmhxm7hhschhb6ERgf5z70
  lX5G22XLkH97mkZbX19aCH6xMmvVUaWpKpC1vrW+ZL8nLzWl8UXVONgqa1NvkIz2
  qUJNdGVgFXaSlH4EaK9FzklpHj1uo8KJdC6m33z8eoFpLREycbSkxISATseQF1y0
  WhpvZ0qB6aRft7OM4B1G0tu1+dlZ3Sh6rrCwR+yCw8vfYR4cUA9e8WFU7YciuTXK
  l/1q3LfzU8LCe0Gtv29Ahk8Zb6lG7/XHwHG8diuKvyq4qlTNp/SjCJbuUx6RSBjD
  zP1nRacRuKrxI9ybZ8MCAwEAAaN0MHIwHwYDVR0jBBgwFoAUmtzqDGWl1NWKvUAi
  yR877VbODwAwHQYDVR0OBBYEFJrc6gxlpdTVir1AIskfO+1Wzg8AMA8GA1UdEwEB
  /wQFMAMBAf8wDgYDVR0PAQH/BAQDAgEGMA8GA1UdJQQIMAYGBFUdJQAwDQYJKoZI
  hvcNAQELBQADggEBAEa4NJ8y4OJLpbCC7SCGrGGTJ+ssbVIJdji21F3dn5yIPQfd
  M/PM84y2cy6Tp9cvaDjOtagZ2e1Et5TeGZHiUeqlAjWDtY5lgGvJ80VwpxAUDhKn
  LGfSMZo1v1gKKVxgh+iaof2L1UCtep5ETsYKeXLkgWsHYBFzqBlhiAZGuQVzaH7T
  I66rtw6gOAmJuWoJlJyhVxg0vCgcl0ExaK3LRhkodzGHIonyaEtRCynpgJ4DmIjH
  1I7OVqjdHhdt98U2A8oZVNcuwHLkfyXIC6Iu3GVs5IsQudiQwTW/kIOR+Chvu/lC
  b/VmGj0MhvmYYc494vWdcNcfED/HPNshio66aiU=
  -----END CERTIFICATE-----
  ",
  "private_key": 
  "-----BEGIN RSA PRIVATE KEY-----
  Proc-Type: 4,ENCRYPTED
  DEK-Info: AES-128-CBC,D1CE2F7C3BD77CB130E563CDECB4AB5E

  NyTth6D4/xeeQ59tn7pGDBhxbGaAsQpTowATdRRnK3Xn4M7lFo1khTUgfKL+eKPz
  5RRf85LfIl4P8/VCgpEsExnaIR/M5FoP3vYIMy3u9cyowG3ioMaQ1ZA/zFdq8jWb
  4H5/GL8Zi7B/nj8dCy7L1gLC5KOpGZLq3wvyxHMl5+X5fbHvb9KJjsW2eFPL9KEI
  yKMRpXET7F0JIBNVHKMX+cUvzXLxH1klHRYSzAWfvoW+wXweKveSvn7wFAxoBjsk
  UtnQ/tZvdfqOYMyfwfb4yNGaQjvN0pfYKWvGu1mqajpPNVJ96n9onArV40I7/Q2D
  51eDFQ8op/0sygZiU1rurTQnvrvZnvgASrqIDdUQBPJaYLQmDIxc7Wo1Qr6cFKMv
  kLNCihBNMar5+LsigyTdb+0VlwgcYtVMUlh8O282LqC11NkVJfAAvDYxZq+SFF1a
  hm7D0n9DFT4A2eeXerwNXyk2fAaw8KX12TpXWanRaB1NW2cX9XmzjMQuk04xNLVK
  DDMHKUDctBBvYHaBAjkUQT2smRH4ETosiQHcI91iuj2DZ6u/T0uUG3N7gHV3KSOX
  DWUBtr/Xok9YuBICJ4gE/tIvH4gaqAqSEWb9TeeSCrX5VdQw03tPWUYKcr9M08Zj
  LOMFdlmMOhRbmsglZy9/D+HVShp343DoZqKIO1A1aGYrzDV6izwI1K1an1ugOF3X
  2czjyeuMtcz2ZFEhuGYekRiTx+ifu2scRnx2vndi9+RESUhh37BeseQgsENIsaw+
  5SVJlRgxk8N2hSiA8AWAJ/xpgyhYNL3KjAfh2tfH+jUtrN48kaa4JPeYykpk2kDi
  OwQD0VhxjAT0ggyeBDbVNat+0w42i9oxpafBx2pCAbnK+WDnnLbUzgobz296fkO1
  H0UUqKBmi28Jntq3ubbg989LRH3VdvOXFvvgI3k2nqKLjzSCZt4MkAH+fo6cFtTf
  q2S+geomeYBCGCSF/bgmk1Q/o9e2qPU4XuYcbM0T2ALwW4vYqv9DmORAfXZV/pg4
  myt1tgsnsUig5UMNIW/g7Q9hnVFzUjOKRwLff+sGKhXwmNHKpJVGaWNaESJ0YAAe
  ESMMOrEW5kiqRqIbZx52NVwb85rb6ozkm8vR4ApLNNqQ/ylAd4H3zA3bByXn3uTx
  7tfksErzsD8seL3yvQV5hkbB8PkQIXCTyL+zbp4+bNk8v3zj9/7BRqpQl0eMJ4oS
  0vjkYgzkhBsQY3tvRH3PkodUy1yhc+1ZOjOcmX4lAMW1+vP5XsESM+GESDp3Czp6
  DlfiHbAlGBouWisY63hQtxVQtOboLzWmXwBGv2ENCf5NdW8tT2rWdxVcWOCW/1YE
  dZ3/Q43GK0rqQw/j6MN4xOY7JuiBftZiBkLv57UIxUH1owIMR501QLnhq7Olgz+V
  Edli5gWpO6OFNGYFhHc8B4FmTq+UUX4bdya/ajbVL/JWH6fjBJsvculQaJGV+Po6
  0Ythfdurd/V0H/s9IkA3XGGckN+XacKpsgr+25kAG5SrdnnZkTVeg1+O/VHiupQw
  OkKlD717/MrLYCZvy2D30oCTDF33VUOxSusc9zeJP29ye+WuNG3gX9CVaYbx1I2d
  -----END RSA PRIVATE KEY-----",
  "PRIVATE_KEY_PHRASE":"123456",
  "SCENE":"ANT",
  "CALLER":"ob_ssl_crypt",
  "CERT_NAME":"ob_yanhua_test1",
  "PRIVATE_KEY_NAME":"ob_yanhua_test1-app-id-authn-RSA-2048-private",
  "KEY_VERSION":"1"
  }';

  alter system set ssl_external_kms_info = '
  {
  "ssl_mode":"bkmi",
  "kms_host":"http://bkmi.stable.alipay.net/bkmi/api", 
  "root_cert": 
  "-----BEGIN CERTIFICATE-----
  MIIDLjCCAhYCBwV0G8gh75EwDQYJKoZIhvcNAQELBQAwWjEsMCoGA1UEAwwjQW50
  IEZpbmFuYWNpYWwgSW50cmFuZXQgQ0EgUm9vdCBSU0ExFzAVBgNVBAoMDkFudCBG
  aW5hbmFjaWFsMREwDwYDVQQLDAhJbnRyYW5ldDAeFw0xODA4MjMxNTE5MTRaFw00
  ODA4MjMxNTE5MTRaMFoxLDAqBgNVBAMMI0FudCBGaW5hbmFjaWFsIEludHJhbmV0
  IENBIFJvb3QgUlNBMRcwFQYDVQQKDA5BbnQgRmluYW5hY2lhbDERMA8GA1UECwwI
  SW50cmFuZXQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCmxsqRHFuF
  D+0HNTgjJM5ijRwur1XAa77/wG/SWfpYNy3Bhith49Nc9Rc/rtelyxWDZHUoDHUS
  4wEkeUSGmMNb8NPNPbwaTcoOGvqSFMzvvvLywGJw3hvaCpse2iknvj+1XMTmgxOe
  GpkyAhPSLzYeyzTHdEKed5pwemdLi5ULWO7HODaq93kGKZjNpx8fXn1h2H0cYrvR
  QqDER5DIrN1AJ295ywmOJ6sRUQZO5wd0LYYNfSiM+g9k1vyH/kTnf7an1musI6kY
  7GksYJt/wvpBO2elmjD/vrHZYZ2fqH1epV2hjoYNq10KpyTq4g9iP0wtcvZUGRgG
  FJ7MBMSwxs9RAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAGSjYHg1Sbu1j5P3etq5
  vu9elMKH4t3FztEkVf4uXIUUPDkJsWcyzdhCzeLXR6a7CUWR7LpEEK+GJDwv6ARB
  xPDD5KlS2gv82Yq48uEs/Zn5U5VvsOyPCLJ0UKvJIALeLAztko96NB9MS9DL0MYE
  hbE84Cbk6MGu6uLwXb68y5pLKXURqr0xVkdIKEBAj63xiMI7Xcr9HmJ8890m2nh2
  M1Wp9a5tCeZPXOmSTVic0sFWDGJwWia06S51sy1bu2aBCLJhWWJz4/jJlODaax5B
  eNn3S+W9DzYGh2FMb8RBg0hAZkFW1pIhXqglB2Q2tClLMeBtZILvW0HJDBMwrK2t
  b7E=
  -----END CERTIFICATE-----
  ",
  "private_key": 
  "-----BEGIN RSA PRIVATE KEY-----
  Proc-Type: 4,ENCRYPTED
  DEK-Info: AES-128-CBC,0E89B082F30023211058CEA54450408C

  BBbOWMC196O3mIHHQnYZG4ZYvMICnftbFTPsvCT39453t+SKn3Z6uvyrm5wg6Ih0
  wKrCq1+Ym8bn1ypQImZnNycWFph6kt28yAd6JoOEAddR23x6JW13g2HmP720rQaZ
  iUoiuNRRab0UQOCql7PC7GDC/0zxsOOux4Vqf0kJVUdo7TiE4gyp5xdDS1/gkARp
  BsRSlb7vwt6X/S6d0CcUurNI5WUhIiD62yfFkLzb0Rebpk8EOKQLzfMPRhVHxjTG
  1aCXL6y2+yMtSJC5Smggj/llxtIplIgWWW4oRjizYnb5PWTJY1BUZAGYtAez5WhX
  neBjZ4xv24S1PoVMv9sId5oObffbnrr3i+dXBeYG2onJfCbn06X9qZLH6zvJ/hMl
  j7H3gopckmvBmClz62TM4hcF/YUPqnLol7s7zlra4u7HwdNoDhRhSZL2lckk+8zK
  o527j6KOP6Y0cpTnU8Qx70vifkwoNUx3GFioyg6FDVLbAz1dGW4+fhgXHe9ZgVqi
  7jKxohMZBH7g6kiqVDoFuDhaWgC1bkG0ioV0AXR5GSaqkdnSRcm1gqFmtUbsHGLL
  OIgkZOt09IhqrfNmr3LW227ypOneHJ8SXj2RDcFbvR6s4CZxw8RMW7j4CKpwZb3Z
  upI2JpjVMh/aYe+PGzEV444wOYXYZ+BJBkGAg1ZGikBXuXhJX5sziI42/Gu7c8HR
  mIasmKgTLIAYerz94aEMjp2DmkYmLRzxe+dm/oSQvG/up14KT2o5ylAMA8mjqPYM
  YgPw7Gi1Rbk/8oCj9SuukWvOW0IKiYi0QaSr3NWSsDypZP2oOf11NHnkSR8mSjLC
  Wf7Q8saxaJVL6LJqgOaxKDzoTISvRM/kowbPP3iNpbCCJFZkwmKl+iHz9ienJVAS
  uW6+QHuajwmxB0i6r+dUeLURyYaYEzM0SOrH/qY1CZKhEh9SeWJsifeUcgrZt7sk
  ZKco0DavJDYyPdidBXIeETT6Xp7kGN8MHMXrUGR4TGWSRrJtxv4YU0k6v+biER+H
  SsVV/m9mI2r0cUPTQUjMbETxITYOtOmRo2GAB7XPaRsxlfNv1Z0KA/JXcbfH/akW
  AFLrS5sMGJMPIzxju49MQbztydMEuEh8vsEIVB5hHK5ygx6pzHndOForkdEYMk0W
  y56MaqrDNeCuvM0Lnwi9UeeLl6HI8InJw1B+3en8XvB+rEOURxqjzDVgw2qUCAm3
  O4UArwxE97GZS/s1sgtJElikgXWspgJgqULPzlJTcrw1tD19ZL0ShG1XZpwPpbZp
  g5enxKoCjZ3M4fhQkp6isiidk3gaJ02LScvBO5bxqnxSvllaHqm7QozUQ/ObHWcf
  ZohJmcxY9wSIjJUvkKjKmnhOoIBAtdS6t8HC5z+3GNv0543ubRz16mQSNFX0nk0U
  8GRJGZOvO4ofh8d/kvxpIRN+Jgr4hdvUnWMJSIHGq9xMC5pID3mQOWuOJEsCp6xQ
  wWX54yRa0jFSWH7SFhr5wtgq54kUkE6/q8mN4Kk5N/NcXxg++c7etMWFSZh0ZvzQ
  b7Ke4gUHzK4ulDaIVIAw64ljfNutOh0quRmUfv5I0obTsqi7XhH+gv+M+etwmTOW
  -----END RSA PRIVATE KEY-----
  ",
  "PRIVATE_KEY_PHRASE":"123456",
  "SCENE":"ANT",
  "CALLER":"ob_ssl_crypt",
  "CERT_NAME":"ob_yanhua_test1",
  "PRIVATE_KEY_NAME":"ob_yanhua_test1-app-id-authn-RSA-2048-private",
  "KEY_VERSION":"1"
  }';

  ```

## 在客户端配置 SSL 相关参数

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

设置 `ssl_client_authentication` 为 `TRUE`，即可开启 SSL/TLS 加密认证。

```shell
obclient> ALTER SYSTEM SET ssl_client_authentication=TRUE;
obclient> SHOW PARAMETERS LIKE 'ssl_client_authentication';
```

设置 OBServer 可以通过的白名单，name 要与生成客户端证书的 name 保持一致。

```shell
obclient> ALTER SYSTEM SET ob_ssl_invited_common_names='obclient'
```

修改参数后，重启数据库。

## 创建使用 SSL 连接的数据库用户

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

为了增加灵活性，OceanBase 数据库可以为每个数据库用户指定不同的 SSL 认证机制。具体操作如下：

* SSL 单向认证。

  服务器端需要 CA 证书，客户端无需提供 CA 证书。客户端单向校验服务器端证书的有效性。

  示例如下：

  ```shell
  obclient> CREATE USER **user1** IDENTIFIED BY **1** REQUIRE SSL;
  ```

* X509 双向认证。

  服务器端和客户端都需要 CA 证书，服务器端和客户端双向校验证书的有效性。

  示例如下：

  ```shell
  obclient> CREATE USER **user2** IDENTIFIED BY **1** REQUIRE X509;
  ```

* 特殊双向认证（可组合）

  * 指定加密算法认证：基于 X509 双向认证，同时限定 SSL 加密算法。

  * 指定发行方认证：基于 X509 双向认证，同时限定客户端 CA 证书发行方。

  * 指定 SSL 主体认证：基于 X509 双向认证，同时限定客户端 CA 证书主体。

  限定加密算法为 DHE-RSA-AES128-GCM-SHA256，并指定 SSL 主体。示例如下：

  ```shell
  obclient> CREATE USER **user3** IDENTIFIED BY **1**
  REQUIRE CIPHER 'DHE-RSA-AES128-GCM-SHA256'
  SUBJECT '/C=CN/ST=ZJ/L=HZ/O=OceanBase/OU=PD/CN=obclient';
  ```

## 授予用户数据库访问权限

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

授予用户访问权限并查看用户属性的具体操作如下：

* 授予用户访问权限。

  ```shell
  obclient> GRANT all privileges on *.* to **user1**;
  obclient> GRANT all privileges on *.* to **user2**;
  obclient> GRANT all privileges on *.* to **user3**;
  ```

* 验证用户属性。

  * MySQL 租户

    ```shell
    SELECT user_name, 
    ssl_type,
    ssl_cipher, 
    x509_issuer, 
    x509_subject, 
    length(ssl_cipher), 
    length(x509_issuer), 
    length(x509_subject) 
    FROM oceanbase.DBA_OB_USERS 
    WHERE user_name LIKE 'SSLTEST%';
    ```

  * Oracle 租户

    ```shell
    obclient> SELECT user_name,
    ssl_type,ssl_cipher,
    x509_issuer,
    x509_subject,
    length(ssl_cipher),
    length(x509_issuer),
    length(x509_subject)
    FROM SYS.ALL_VIRTUAL_USER_AGENT
    WHERE user_name LIKE 'SSLTEST%';
    ```

## 客户端配置和连接

请登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。
复制生成的客户端证书（`ca.pem`、`client-cert.pem`和`client-key.pem`）至客户端可以访问的目录。具体操作如下：

* X509 双向认证

  ```shell
  $ obclient -h <observer-ip> -P2881 -u **user2**@mytenant -p**1** --ssl-ca=/path/to/ca.pem --ssl-cert=/p
  ath/to/client-cert.pem --ssl-key=/path/to/client-key.pem
  ```

* 使用加密算法为 DHE-RSA-AES128-GCM-SHA256

  ```shell
  $ obclient -h <observer-ip> -P2881 -u **user3**@mytenant -p**1** --ssl-ca=/path/to/ca.pem --ssl-cert=/pat
  h/to/client-cert.pem --ssl-key=/path/to/client-key.pem --ssl-cipher=DHE-RSA-AES128-GCM-SHA256
  ```

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>使用 <code>require ssl</code> 和 <code>require none</code> 创建的用户，无需指定证书。</p>
  </main>
ver 传输加密

可以通过以下方法设置 OBServer 的传输加密。

## 创建 CA 证书

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

1. 创建目录存放证书文件。

    <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>证书文件的 Common Name( CN ) 不能相同。</p>
    </main>

    ```shell
    mkdir ~/tls
    chmod 700 ~/tls
    cd ~/tls
    ```

2. 创建 RSA 私钥。

   ```shell
   $ openssl genrsa 2048 > cakey.pem
   Generating RSA private key, 2048 bit long modulus
   ....................................................................+++
   ..............+++
   e is 65537 (0x10001)
   ```

3. 生成 CA 证书。

   ```shell
   $ openssl req -new -x509 -nodes -days 3600 -key cakey.pem -out ca.pem
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [XX]:CN
   State or Province Name (full name) []:ZJ
   Locality Name (eg, city) [Default City]:HZ
   Organization Name (eg, company) [Default Company Ltd]:OceanBase
   Organizational Unit Name (eg, section) []:PD
   Common Name (eg, your name or your server's hostname) []:ob
   Email Address []:
   ```

## 生成服务器证书

登录可以执行 OpenSSL 命令的 OBServer 服务器端机器，进行以下操作。

1. 生成服务器私钥。

   ```shell
   $ openssl req -newkey rsa:2048 -days 3600 -nodes -keyout server-key.pem -out server-req.pem
   Generating a 2048 bit RSA private key
   ............................+++
   ................................+++
   writing new private key to 'server-key.pem'
   -----
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [XX]:CN
   State or Province Name (full name) []:ZJ
   Locality Name (eg, city) [Default City]:HZ
   Organization Name (eg, company) [Default Company Ltd]:OceanBase
   Organizational Unit Name (eg, section) []:PD
   Common Name (eg, your name or your server's hostname) []:observer
   Email Address []:
   Please enter the following 'extra' attributes
   to be sent with your certificate request
   A challenge password []:OceanBase123
   An optional company name []:
   ```

2. 生成服务器证书。

   ```shell
   openssl x509 -req -in server-req.pem -days 3600 -CA ca.pem -CAkey cakey.pem -set_serial 01 -out server-cert.pem
   ```

## 生成客户端证书

登录可以执行 OpenSSL 命令的客户端机器，进行以下操作。

1. 生成客户端私钥。

   ```shell
   $ openssl req -newkey rsa:2048 -days 3600 -nodes -keyout client-key.pem -out client-req.pem
   Generating a 2048 bit RSA private key
   ........................................+++
   ...........................................+++
   writing new private key to 'client-key.pem'
   -----
   You are about to be asked to enter information that will be incorporated
   into your certificate request.
   What you are about to enter is what is called a Distinguished Name or a DN.
   There are quite a few fields but you can leave some blank
   For some fields there will be a default value,
   If you enter '.', the field will be left blank.
   -----
   Country Name (2 letter code) [XX]:CN
   State or Province Name (full name) []:ZJ
   Locality Name (eg, city) [Default City]:HZ
   Organization Name (eg, company) [Default Company Ltd]:OceanBase
   Organizational Unit Name (eg, section) []:PD
   Common Name (eg, your name or your server's hostname) []:obclient
   Email Address []:
   Please enter the following 'extra' attributes
   to be sent with your certificate request
   A challenge password []:OceanBase123
   An optional company name []:
   ```

2. 生成客户端证书。

   ```shell
   $ openssl x509 -req -in client-req.pem -days 3600 -CA ca.pem -CAkey cakey.pem -set_serial 01 -out client-cert.pem
   Signature ok
   subject=/C=CN/ST=ZJ/L=HZ/O=OceanBase/OU=PD/CN=obclient
   Getting CA Private Key
   ```

## 验证证书文件

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

```shell
$ openssl verify -CAfile ca.pem server-cert.pem client-cert.pem
server-cert.pem: OK
client-cert.pem: OK
```

## 在服务端开启 SSL

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

1. 在服务端的 OceanBase 数据库的安装目录下创建子目录 `wallet/`，默认在 `/home/admin/oceanbase/wallet/`。

   ```shell
   mkdir /home/admin/oceanbase/wallet/
   ```

2. 复制服务端相关的 3 个文件 `ca.pem`、`server-key.pem` 和 `server-cert.pem` 至 安装目录 `wallet/` 下。

   ```shell
   $ cp ca.pem server-key.pem server-cert.pem /home/admin/oceanbase/wallet/
   $ chmod 700 /home/admin/oceanbase/wallet/*.pem
   $ ls -l /home/admin/oceanbase/wallet/
   total 12
   -rwx------ 1 admin admin 1269 Oct 27 20:05 ca.pem
   -rwx------ 1 admin admin 1151 Oct 27 20:05 server-cert.pem
   -rwx------ 1 admin admin 1675 Oct 27 20:05 server-key.pem
   ```

## 在客户端配置 SSL 相关参数

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

设置 `ssl_client_authentication` 为 `TRUE`，即可开启 SSL/TLS 加密认证。

```shell
obclient> ALTER SYSTEM SET ssl_client_authentication=TRUE;
obclient> SHOW PARAMETERS LIKE 'ssl_client_authentication';
```

设置 OBServer 可以通过的白名单，name 要与生成客户端证书的 name 保持一致。

```shell
obclient> ALTER SYSTEM SET ob_ssl_invited_common_names='obclient'
```

修改参数后，重启数据库。

## 创建使用 SSL 连接的数据库用户

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

为了增加灵活性，OceanBase 数据库可以为每个数据库用户指定不同的 SSL 认证机制。具体操作如下：

* SSL 单向认证。

  服务器端需要 CA 证书，客户端无需提供 CA 证书。客户端单向校验服务器端证书的有效性。

  示例如下：

  ```shell
  obclient> CREATE USER **user1** IDENTIFIED BY **1** REQUIRE SSL;
  ```

* X509 双向认证。

  服务器端和客户端都需要 CA 证书，服务器端和客户端双向校验证书的有效性。

  示例如下：

  ```shell
  obclient> CREATE USER **user2** IDENTIFIED BY **1** REQUIRE X509;
  ```

* 特殊双向认证（可组合）

  * 指定加密算法认证：基于 X509 双向认证，同时限定 SSL 加密算法。

  * 指定发行方认证：基于 X509 双向认证，同时限定客户端 CA 证书发行方。

  * 指定 SSL 主体认证：基于 X509 双向认证，同时限定客户端 CA 证书主体。

  限定加密算法为 DHE-RSA-AES128-GCM-SHA256，并指定 SSL 主体。示例如下：

  ```shell
  obclient> CREATE USER **user3** IDENTIFIED BY **1**
  REQUIRE CIPHER 'DHE-RSA-AES128-GCM-SHA256'
  SUBJECT '/C=CN/ST=ZJ/L=HZ/O=OceanBase/OU=PD/CN=obclient';
  ```

## 授予用户数据库访问权限

登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。

授予用户访问权限并查看用户属性的具体操作如下：

* 授予用户访问权限。

  ```shell
  obclient> GRANT all privileges on *.* to **user1**;
  obclient> GRANT all privileges on *.* to **user2**;
  obclient> GRANT all privileges on *.* to **user3**;
  ```

* 验证用户属性。

  * MySQL 租户

    ```shell
    obclient> SELECT user_name,
    ssl_type,ssl_cipher,
    x509_issuer,
    x509_subject,
    length(ssl_cipher),
    length(x509_issuer),
    length(x509_subject)
    FROM oceanbase.__all_user
    WHERE user_name LIKE 'SSLTEST%';
    ```

  * Oracle 租户

    ```shell
    obclient> SELECT user_name,
    ssl_type,ssl_cipher,
    x509_issuer,
    x509_subject,
    length(ssl_cipher),
    length(x509_issuer),
    length(x509_subject)
    FROM SYS.ALL_VIRTUAL_USER_AGENT
    WHERE user_name LIKE 'SSLTEST%';
    ```

## 客户端配置和连接

请登录可以执行 OpenSSL 命令的 OBServer 服务器或者客户端机器，进行以下操作。
复制生成的客户端证书（`ca.pem`、`client-cert.pem`和`client-key.pem`）至客户端可以访问的目录。具体操作如下：

* X509 双向认证

  ```shell
  $ obclient -h <observer-ip> -P2881 -u **user2**@mytenant -p**1** --ssl-ca=/path/to/ca.pem --ssl-cert=/p
  ath/to/client-cert.pem --ssl-key=/path/to/client-key.pem
  ```

* 使用加密算法为 DHE-RSA-AES128-GCM-SHA256

  ```shell
  $ obclient -h <observer-ip> -P2881 -u **user3**@mytenant -p**1** --ssl-ca=/path/to/ca.pem --ssl-cert=/pat
  h/to/client-cert.pem --ssl-key=/path/to/client-key.pem --ssl-cipher=DHE-RSA-AES128-GCM-SHA256
  ```

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>使用 <code>require ssl</code> 和 <code>require none</code> 创建的用户，无需指定证书。</p>
  </main>
